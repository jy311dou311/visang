<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>입력 → 7구역 지도 → 새 화면 (뒤로가기 지원)</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 60px 0; background:#fff; }
    .screen { display: none; }
    .screen.active { display: block; }

    input, select { padding: 10px; margin: 6px; width: 260px; max-width: 90vw; }
    button { padding: 10px 18px; margin-top: 12px; cursor: pointer; }

    .card{
      width: min(980px, 95vw);
      margin: 0 auto;
      border: 1px solid #ddd;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      background: #fff;
      text-align: left;
    }
    .title{
      display:flex; justify-content: space-between; align-items: baseline;
      gap: 10px; margin-bottom: 10px;
    }
    .badge{
      font-size: 12px; padding: 4px 10px; border-radius: 999px;
      border: 1px solid #ddd; background: #f7f7f7; white-space: nowrap;
    }
    .hint { font-size: 13px; color: #666; margin-top: 6px; }

    /* ====== Screen2 레이아웃: 지도 + 나무패널 (지도를 가리지 않음) ====== */
    .map-layout{
      display: grid;
      grid-template-columns: minmax(0, 1fr) 220px;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 860px){
      .map-layout{
        grid-template-columns: 1fr;
      }
    }

    .map-stage{
      position: relative;
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #eee;
      background: #fafafa;
    }
    .map-stage img{
      display: block;
      width: 100%;
      height: auto;
      user-select: none;
      -webkit-user-drag: none;
    }
    .map-stage svg{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* ✅ 클릭 구역 hover 강조(더 잘 보이게) */
    .region{
      fill: rgba(0,0,0,0);
      cursor: pointer;
      transition: fill 160ms ease, stroke 160ms ease, filter 160ms ease;
    }
    .region:hover{
      fill: rgba(0, 123, 255, 0.25);
      stroke: rgba(0, 123, 255, 0.9);
      stroke-width: 3;
      filter: drop-shadow(0 0 6px rgba(0,123,255,0.45));
    }

    .btn-row{
      display:flex; justify-content:center; gap: 10px;
      flex-wrap: wrap; margin-top: 12px;
    }

    .viewer {
      display: grid;
      gap: 12px;
      place-items: center;
      text-align: center;
      padding-top: 6px;
    }

    /* ====== Screen3: 이미지 프레임 + 캐릭터 오버레이 ====== */
    .photoFrame{
      position: relative;
      width: 100%;
      max-width: 420px;
    }
    .viewer img#regionImage{
      width: 100%;
      max-width: 420px;
      height: 260px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #eee;
      background: #fafafa;
      transform-origin: center center;
      transition: transform 140ms ease;
      display:block;
    }
    .characterHotspot{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(1.03);
      width: 72px;
      height: 72px;
      object-fit: contain;
      cursor: pointer;
      user-select: none;
      -webkit-user-drag: none;
      border-radius: 0;
      box-shadow: none;
      background: none;
      backdrop-filter: none;
      transition: transform 120ms ease;
      opacity: 0.96;
    }
    .characterHotspot:hover{
      transform: translate(-50%,-50%);
      opacity: 1;
    }

    /* ✅ 툴팁(마우스 오버 시 장소명 표시) */
    .tooltip {
      position: fixed;
      z-index: 9999;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,0.78);
      color: #fff;
      font-size: 13px;
      line-height: 1.2;
      pointer-events: none;
      opacity: 0;
      transform: translate(-50%, -120%);
      transition: opacity 80ms ease;
      white-space: nowrap;
    }
    .tooltip.show { opacity: 1; }

    .title-right{
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .reset-mini{
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .reset-mini:hover{
      background: #f6f6f6;
    }

    /* ===== 모달 ===== */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal.show{ display: flex; }
    .modal-card{
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      width: min(360px, 90vw);
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    .modal-card input{
      width: 100%;
      padding: 10px;
      margin: 12px 0;
    }
    .modal-actions{
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    /* ===== Screen2 나무 패널(이미지 기반) ===== */
    .treePanel{
      border: 1px solid #eee;
      border-radius: 14px;
      background: #fafafa;
      padding: 10px;
      position: sticky;
      top: 14px;
    }
    @media (max-width: 860px){
      .treePanel{ position: relative; top: auto; }
    }
    .treePanelHeader{
      display:flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .treeCount{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      white-space: nowrap;
      color:#333;
      font-weight: 700;
    }
    .treeStage{
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1.15;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #eee;
      background: #fff;
    }
    .treeStage img.treeImg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: contain;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }
    .leafImg{
      position:absolute;
      width: 26px;
      height: 26px;
      object-fit: contain;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.18));
      transform: rotate(var(--rot, 0deg)) scale(var(--sc, 1));
      transform-origin: center;
      opacity: 0.98;
      animation: leafPop .16s ease-out;
    }
    @keyframes leafPop{
      from{ transform: rotate(var(--rot,0deg)) scale(0.6); opacity: 0.2; }
      to{ transform: rotate(var(--rot,0deg)) scale(var(--sc, 1)); opacity: 0.98; }
    }
    .treeActions{
      display:flex;
      gap: 8px;
      justify-content: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .miniBtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .miniBtn:hover{ background:#f6f6f6; }
  </style>
</head>
<body>

  <!-- 1) 입력 화면 -->
  <div id="screen1" class="screen active">
    <h1>정보 입력</h1>

    <input type="text" id="name" placeholder="이름" autocomplete="name" /><br>

    <select id="department">
      <option value="">부서 선택</option>
      <option value="에듀테크콘텐츠1">에듀테크콘텐츠1</option>
      <option value="라키비움">라키비움</option>
      <option value="기출탭탭">기출탭탭</option>
      <option value="국어2">국어2</option>
      <option value="티칭콘텐츠개발3">티칭콘텐츠개발3</option>
    </select><br>

    <button id="nextBtn">다음</button>
  </div>

  <!-- 2) 지도 화면 (7구역) -->
  <div id="screen2" class="screen">
    <div class="card">
      <div class="title">
         <div>
             <h2 style="margin:0">7구역 선택</h2>
             <div class="hint">지도에서 구역을 클릭하면 상세 화면으로 이동해요.</div>
         </div>

         <div class="title-right">
             <div class="badge" id="userBadge"></div>
             <button id="resetBtn" class="reset-mini">저장값 초기화</button>
         </div>
     </div>

      <!-- ✅ 지도 + 나무 (지도를 안 가림) -->
      <div class="map-layout">
        <div class="map-stage">
          <img src="floor.png" alt="지도">

          <svg viewBox="0 0 1536 1024" preserveAspectRatio="xMidYMid meet" aria-label="클릭 가능한 7구역">
            <rect class="region" data-region="휴담" x="205" y="115" width="466" height="110" rx="28" ry="28"></rect>
            <rect class="region" data-region="통실" x="671" y="115" width="765" height="287" rx="28" ry="28"></rect>
            <rect class="region" data-region="스마트 클래스" x="1365" y="402" width="70" height="253" rx="28" ry="28"></rect>
            <rect class="region" data-region="도서관" x="97" y="225" width="203" height="447" rx="28" ry="28"></rect>
            <rect class="region" data-region="스마트아카이브" x="97" y="780" width="248" height="88" rx="28" ry="28"></rect>
            <rect class="region" data-region="교과서의 역사" x="345" y="780" width="841" height="88" rx="28" ry="28"></rect>
            <rect class="region" data-region="에듀테크존" x="315" y="225" width="248" height="70" rx="28" ry="28"></rect>
          </svg>
        </div>

        <!-- ✅ 나무 패널 -->
        <aside class="treePanel" aria-label="나무 패널">
          <div class="treePanelHeader">
            <div style="font-weight:700;color:#333;">나무</div>
            <div class="treeCount" id="leafCountBadge">0개</div>
          </div>

          <div class="treeStage" id="treeStage">
            <!-- 네가 넣을 나무 이미지 -->
            <img class="treeImg" src="tree.png" alt="나무">
            <!-- 잎은 JS로 추가됨 -->
          </div>

          <div class="treeActions">
            <button class="miniBtn" id="clearTreeBtn" type="button">잎 초기화(화면용)</button>
          </div>

          <div class="hint" style="margin-top:8px;">
            ※ 누가 어디서든 한 줄 저장하면 잎이 1개 생겨요.
          </div>
        </aside>
      </div>

      <div class="btn-row">
        <button id="backBtn">뒤로</button>
      </div>
    </div>
  </div>

  <!-- 3) 구역 상세 화면 -->
  <div id="screen3" class="screen">
    <div class="card">
      <div class="title">
        <div>
          <h2 style="margin:0" id="regionTitle">구역</h2>
          <div class="hint" id="regionSub">공간을 소개합니다.</div>
          <!-- ✅ 구역별 질문 표시 -->
          <div class="hint" id="regionQuestion" style="margin-top:8px; font-weight:600; color:#333;"></div>
        </div>
        <div class="badge" id="userBadge3"></div>
      </div>

      <div class="viewer">
        <!-- ✅ 이미지 위에 캐릭터 얹기 -->
        <div class="photoFrame">
          <img id="regionImage" alt="선택된 구역 이미지">

          <!-- 네가 넣을 캐릭터 이미지 -->
          <img
            id="characterHotspot"
            class="characterHotspot"
            src="character.png"
            alt="한 줄 입력하기"
            title="클릭해서 한 줄 입력"
          />
        </div>
      </div>

      <div class="btn-row">
        <button id="toMapBtn">지도 돌아가기</button>
      </div>
    </div>
  </div>

  <!-- 툴팁 -->
  <div id="tooltip" class="tooltip"></div>

  <!-- ✅ 답변 입력 모달 -->
  <div id="commentModal" class="modal">
    <div class="modal-card">
      <h3 style="margin-top:0">답변 입력</h3>
      <div id="questionText" class="hint" style="margin-top:-6px;"></div>
      <input
        type="text"
        id="commentInput"
        placeholder="여기에 한 줄로 입력"
        maxlength="80"
      >
      <div class="modal-actions">
        <button id="saveCommentBtn">저장</button>
        <button id="closeCommentBtn">취소</button>
      </div>
      <div class="hint" style="margin-top:10px;">※ 중앙수집.</div>
    </div>
  </div>

  <!-- ✅ Firebase + 기존 로직 합본 -->
  <script type="module">
    /* =========================
       1) Firebase 설정
       ========================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8n3EetbrAOmJ9BFy7tdSxKjwbobqOcP8",
      authDomain: "visang-find.firebaseapp.com",
      projectId: "visang-find",
      storageBucket: "visang-find.firebasestorage.app",
      messagingSenderId: "543146477593",
      appId: "1:543146477593:web:cf26b2d26ab15893d50288"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function saveCommentToFirestore(region, question, text, name, department) {
      await addDoc(collection(db, "comments"), {
        region,
        question,
        text,
        name,
        department,
        createdAt: serverTimestamp()
      });
    }

    /* =========================
       2) Tree(이미지) + Leaves(이미지 5개) 설정
       - 너는 아래 파일명만 맞춰서 넣으면 됨
       ========================= */
    const LEAF_IMAGES = [
      "leaf1.png",
      "leaf2.png",
      "leaf3.png",
      "leaf4.png",
      "leaf5.png",
    ];

    // ✅ 잎이 들어갈 “지정 위치들”(treeStage 기준 퍼센트)
    // 필요하면 여기 숫자만 너가 조정하면 됨.
    const LEAF_POSITIONS = [
      { x: 22, y: 22 }, { x: 35, y: 18 }, { x: 50, y: 20 }, { x: 65, y: 18 }, { x: 78, y: 22 },
      { x: 18, y: 35 }, { x: 32, y: 33 }, { x: 48, y: 34 }, { x: 62, y: 33 }, { x: 82, y: 36 },
      { x: 22, y: 50 }, { x: 38, y: 48 }, { x: 52, y: 50 }, { x: 68, y: 48 }, { x: 80, y: 52 },
      { x: 28, y: 64 }, { x: 44, y: 64 }, { x: 58, y: 66 }, { x: 72, y: 64 }, { x: 36, y: 74 },
    ];

    // 저장 키
    const KEY_NAME = "saved_name";
    const KEY_DEPT = "saved_department";
    const KEY_REGION = "saved_region";

    // ✅ 잎 상태 저장(화면용)
    const KEY_LEAVES = "tree_leaves_v1"; // [{leafIdx, posIdx, rot, sc}, ...]
    const KEY_LEAF_COUNT = "tree_leaf_count_v1"; // number

    /* =========================
       3) 화면 DOM
       ========================= */
    const screen1 = document.getElementById("screen1");
    const screen2 = document.getElementById("screen2");
    const screen3 = document.getElementById("screen3");

    const nameInput = document.getElementById("name");
    const deptSelect = document.getElementById("department");

    const nextBtn = document.getElementById("nextBtn");
    const backBtn = document.getElementById("backBtn");
    const resetBtn = document.getElementById("resetBtn");
    const toMapBtn = document.getElementById("toMapBtn");

    const userBadge = document.getElementById("userBadge");
    const userBadge3 = document.getElementById("userBadge3");

    const regionTitle = document.getElementById("regionTitle");
    const regionSub = document.getElementById("regionSub");
    const regionImage = document.getElementById("regionImage");
    const regionQuestionEl = document.getElementById("regionQuestion");

    // ✅ 캐릭터 핫스팟
    const characterHotspot = document.getElementById("characterHotspot");

    // 모달
    const commentModal = document.getElementById("commentModal");
    const commentInput = document.getElementById("commentInput");
    const saveCommentBtn = document.getElementById("saveCommentBtn");
    const closeCommentBtn = document.getElementById("closeCommentBtn");
    const questionText = document.getElementById("questionText");

    // 구역 요소
    const regionEls = document.querySelectorAll(".region");

    // 나무
    const treeStage = document.getElementById("treeStage");
    const leafCountBadge = document.getElementById("leafCountBadge");
    const clearTreeBtn = document.getElementById("clearTreeBtn");

    /* =========================
       4) 구역 매핑
       ========================= */
    const regionToImage = {
      "휴담": "hudam.png",
      "통실": "tongsil.png",
      "스마트 클래스": "smart-class.png",
      "도서관": "library.png",
      "스마트아카이브": "archive.png",
      "교과서의 역사": "history.png",
      "에듀테크존": "edutech.png",
    };

    const regionToText = {
      "휴담": "문구를 입력하세요",
      "통실": "문구를 입력하세요",
      "스마트 클래스": "문구를 입력하세요",
      "도서관": "문구를 입력하세요",
      "스마트아카이브": "문구를 입력하세요",
      "교과서의 역사": "문구를 입력하세요",
      "에듀테크존": "문구를 입력하세요",
    };

    const regionToQuestion = {
      "휴담": "문구를 입력하세요",
      "통실": "문구를 입력하세요",
      "스마트 클래스": "문구를 입력하세요",
      "도서관": "문구를 입력하세요",
      "스마트아카이브": "문구를 입력하세요",
      "교과서의 역사": "문구를 입력하세요",
      "에듀테크존": "문구를 입력하세요",
    };

    const regionRotation = {
      "휴담": 0,
      "통실": 0,
      "스마트 클래스": 0,
      "도서관": 0,
      "스마트아카이브": 0,
      "교과서의 역사": 0,
      "에듀테크존": 0,
    };

    // ✅ (지금은 “정 가운데”) 캐릭터 위치. 나중에 구역별로 여기만 바꾸면 됨.
    const regionToCharacterPos = {
      "휴담": { x: 50, y: 50 },
      "통실": { x: 50, y: 50 },
      "스마트 클래스": { x: 50, y: 50 },
      "도서관": { x: 50, y: 50 },
      "스마트아카이브": { x: 50, y: 50 },
      "교과서의 역사": { x: 50, y: 50 },
      "에듀테크존": { x: 50, y: 50 },
    };

    /* =========================
       5) 라우팅(뒤로가기)
       ========================= */
    function renderScreen(n) {
      screen1.classList.toggle("active", n === 1);
      screen2.classList.toggle("active", n === 2);
      screen3.classList.toggle("active", n === 3);
    }

    function go(screenNum, replace = false) {
      const state = { screen: screenNum };
      const url = `#s${screenNum}`;
      if (replace) history.replaceState(state, "", url);
      else history.pushState(state, "", url);
      renderScreen(screenNum);
    }

    function screenFromHash() {
      const h = (location.hash || "").toLowerCase();
      if (h === "#s2") return 2;
      if (h === "#s3") return 3;
      return 1;
    }

    window.addEventListener("popstate", () => {
      renderScreen(screenFromHash());
    });

    /* =========================
       6) 기본 저장/로딩
       ========================= */
    function saveInputs(name, dept) {
      localStorage.setItem(KEY_NAME, name);
      localStorage.setItem(KEY_DEPT, dept);
    }

    function loadInputs() {
      const savedName = localStorage.getItem(KEY_NAME) || "";
      const savedDept = localStorage.getItem(KEY_DEPT) || "";
      if (savedName) nameInput.value = savedName;
      if (savedDept) deptSelect.value = savedDept;
    }

    function updateBadges() {
      const n = (localStorage.getItem(KEY_NAME) || "").trim();
      const d = localStorage.getItem(KEY_DEPT) || "";
      const text = (n && d) ? `${n} · ${d}` : "";
      userBadge.textContent = text;
      userBadge3.textContent = text;
    }

    function nextScreen() {
      const name = nameInput.value.trim();
      const dept = deptSelect.value;

      if (!name || !dept) {
        alert("이름과 부서를 모두 입력/선택해주세요!");
        return;
      }

      saveInputs(name, dept);
      updateBadges();
      go(2);
    }

    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") nextScreen();
    });
    deptSelect.addEventListener("keydown", (e) => {
      if (e.key === "Enter") nextScreen();
    });

    function openRegion(regionName) {
      localStorage.setItem(KEY_REGION, regionName);

      const imgSrc = regionToImage[regionName];
      regionTitle.textContent = regionName;
      regionSub.textContent = regionToText[regionName] || `${regionName} 공간을 소개합니다.`;

      const q = regionToQuestion[regionName] || "이 공간에 대한 한 줄을 남겨주세요.";
      regionQuestionEl.textContent = `질문: ${q}`;

      if (imgSrc) {
        regionImage.src = imgSrc;
        regionImage.alt = `${regionName} 이미지`;
        const deg = regionRotation[regionName] ?? 0;
        regionImage.style.transform = `rotate(${deg}deg)`;
      } else {
        regionImage.removeAttribute("src");
        regionImage.alt = "이미지가 없습니다.";
        regionImage.style.transform = "rotate(0deg)";
      }

      // ✅ 캐릭터 위치 적용(현재는 중앙)
      const pos = regionToCharacterPos[regionName] || { x: 50, y: 50 };
      characterHotspot.style.left = `${pos.x}%`;
      characterHotspot.style.top = `${pos.y}%`;

      updateBadges();
      go(3);
    }

    function resetAll() {
      localStorage.removeItem(KEY_NAME);
      localStorage.removeItem(KEY_DEPT);
      localStorage.removeItem(KEY_REGION);

      // 화면용 잎도 같이 초기화(원하면 빼도 됨)
      localStorage.removeItem(KEY_LEAVES);
      localStorage.removeItem(KEY_LEAF_COUNT);

      nameInput.value = "";
      deptSelect.value = "";
      alert("저장된 값이 초기화됐어요!");
      renderTreeFromStorage();
      go(1, true);
    }

    nextBtn.addEventListener("click", nextScreen);
    backBtn.addEventListener("click", () => go(1));
    toMapBtn.addEventListener("click", () => go(2));
    resetBtn.addEventListener("click", resetAll);

    regionEls.forEach(el => {
      el.addEventListener("click", () => openRegion(el.dataset.region));
    });

    /* =========================
       7) 툴팁
       ========================= */
    const tooltip = document.getElementById("tooltip");
    function showTooltip(text, clientX, clientY) {
      tooltip.textContent = text;
      tooltip.style.left = `${clientX}px`;
      tooltip.style.top = `${clientY}px`;
      tooltip.classList.add("show");
    }
    function moveTooltip(clientX, clientY) {
      tooltip.style.left = `${clientX}px`;
      tooltip.style.top = `${clientY}px`;
    }
    function hideTooltip() {
      tooltip.classList.remove("show");
    }

    regionEls.forEach(el => {
      const name = el.dataset.region;

      el.addEventListener("mouseenter", (e) => showTooltip(name, e.clientX, e.clientY));
      el.addEventListener("mousemove", (e) => moveTooltip(e.clientX, e.clientY));
      el.addEventListener("mouseleave", hideTooltip);

      el.addEventListener("touchstart", (e) => {
        const t = e.touches[0];
        showTooltip(name, t.clientX, t.clientY);
        setTimeout(hideTooltip, 900);
      }, { passive: true });
    });

    window.addEventListener("scroll", hideTooltip, { passive: true });
    window.addEventListener("resize", hideTooltip);

    /* =========================
       8) 나무/잎 로직 (이미지 5개 랜덤 + 위치 랜덤)
       ========================= */
    function getStoredLeaves(){
      const raw = localStorage.getItem(KEY_LEAVES);
      if(!raw) return [];
      try{
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }

    function setStoredLeaves(arr){
      localStorage.setItem(KEY_LEAVES, JSON.stringify(arr));
    }

    function getLeafCount(){
      const n = Number(localStorage.getItem(KEY_LEAF_COUNT) || "0");
      return Number.isFinite(n) ? n : 0;
    }

    function setLeafCount(n){
      localStorage.setItem(KEY_LEAF_COUNT, String(n));
    }

    function clearRenderedLeaves(){
      treeStage.querySelectorAll(".leafImg").forEach(el => el.remove());
    }

    function renderTreeFromStorage(){
      const leaves = getStoredLeaves();
      clearRenderedLeaves();

      // 뱃지 업데이트
      leafCountBadge.textContent = `${getLeafCount()}개`;

      for(const item of leaves){
        const pos = LEAF_POSITIONS[item.posIdx];
        const src = LEAF_IMAGES[item.leafIdx];
        if(!pos || !src) continue;

        const img = document.createElement("img");
        img.className = "leafImg";
        img.src = src;
        img.alt = "잎";
        img.style.left = `${pos.x}%`;
        img.style.top = `${pos.y}%`;
        img.style.transform = `translate(-50%, -50%) rotate(${item.rot}deg) scale(${item.sc})`;
        treeStage.appendChild(img);
      }
    }

    function addOneLeafToTree(){
      const current = getStoredLeaves();

      // 1) 잎 이미지 랜덤(0~4)
      const leafIdx = Math.floor(Math.random() * LEAF_IMAGES.length);

      // 2) 위치는 "지정 위치" 중에서 랜덤
      //    - 아직 안 쓴 위치가 있으면 그 중에서 랜덤
      //    - 다 찼으면 그냥 전체 중 랜덤(겹칠 수 있음)
      const used = new Set(current.map(x => x.posIdx));
      const available = [];
      for(let i=0;i<LEAF_POSITIONS.length;i++){
        if(!used.has(i)) available.push(i);
      }
      const posIdx = (available.length > 0)
        ? available[Math.floor(Math.random() * available.length)]
        : Math.floor(Math.random() * LEAF_POSITIONS.length);

      // 3) 약간의 랜덤 회전/스케일(자연스럽게)
      const rot = Math.round(-30 + Math.random() * 60); // -30~30
      const sc = Math.round((0.9 + Math.random() * 0.25) * 100) / 100; // 0.9~1.15

      const newItem = { leafIdx, posIdx, rot, sc };
      current.push(newItem);
      setStoredLeaves(current);

      // 카운트 +1 (화면용)
      const n = getLeafCount() + 1;
      setLeafCount(n);

      // 즉시 렌더 (팝 애니메이션은 CSS에서 자동)
      const pos = LEAF_POSITIONS[posIdx];
      const img = document.createElement("img");
      img.className = "leafImg";
      img.src = LEAF_IMAGES[leafIdx];
      img.alt = "잎";
      img.style.left = `${pos.x}%`;
      img.style.top = `${pos.y}%`;
      img.style.transform = `translate(-50%, -50%) rotate(${rot}deg) scale(${sc})`;
      treeStage.appendChild(img);

      leafCountBadge.textContent = `${n}개`;
    }

    clearTreeBtn.addEventListener("click", () => {
      localStorage.removeItem(KEY_LEAVES);
      localStorage.removeItem(KEY_LEAF_COUNT);
      renderTreeFromStorage();
      alert("잎(화면용) 초기화 완료!");
    });

     function makePixelPerfectClickable(imgEl, onHit) {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

     function drawToCanvas() {
      const w = imgEl.naturalWidth;
      const h = imgEl.naturalHeight;
      if (!w || !h) return false;
      canvas.width = w;
      canvas.height = h;
      ctx.clearRect(0, 0, w, h);
      ctx.drawImage(imgEl, 0, 0);
      return true;
      }

      // 이미지 로드 후 캔버스에 복사
     if (imgEl.complete) drawToCanvas();
     imgEl.addEventListener("load", drawToCanvas);

     imgEl.addEventListener("pointerdown", (e) => {
      // 화면좌표 → 이미지 내부좌표
     const rect = imgEl.getBoundingClientRect();
     const x = Math.floor((e.clientX - rect.left) * (imgEl.naturalWidth / rect.width));
     const y = Math.floor((e.clientY - rect.top) * (imgEl.naturalHeight / rect.height));

     if (x < 0 || y < 0 || x >= imgEl.naturalWidth || y >= imgEl.naturalHeight) return;
     if (!imgEl.naturalWidth || !imgEl.naturalHeight) return;

     // 픽셀 알파 체크
     const pixel = ctx.getImageData(x, y, 1, 1).data; // [r,g,b,a]
     const alpha = pixel[3];

      // 알파 임계값(0~255). 20~40 정도 추천
     if (alpha > 20) onHit(e);
     });
    }


    /* =========================
       9) 모달(캐릭터 클릭 → 답변 입력)
       ========================= */
    function openCommentModal(){
      const region = localStorage.getItem(KEY_REGION);
      if (!region) return;

      const q = regionToQuestion[region] || "이 공간에 대한 한 줄을 남겨주세요.";
      questionText.textContent = q;

      commentInput.value = "";
      commentModal.classList.add("show");
      commentInput.focus();
    }

    // ✅ 버튼 대신 캐릭터 클릭
    makePixelPerfectClickable(characterHotspot, () => {
     openCommentModal();
    });

    closeCommentBtn.addEventListener("click", () => {
      commentModal.classList.remove("show");
    });

    commentModal.addEventListener("click", (e) => {
      if (e.target === commentModal) commentModal.classList.remove("show");
    });

    saveCommentBtn.addEventListener("click", async () => {
      const region = localStorage.getItem(KEY_REGION);
      const text = commentInput.value.trim();

      if (!text) {
        alert("답변을 입력해주세요!");
        return;
      }

      const name = (localStorage.getItem(KEY_NAME) || "익명").trim();
      const department = localStorage.getItem(KEY_DEPT) || "";
      const question = regionToQuestion[region] || "이 공간에 대한 한 줄을 남겨주세요.";

      try {
        await saveCommentToFirestore(region, question, text, name, department);

        // ✅ 저장 성공 → 잎 1개 추가
        addOneLeafToTree();

        commentModal.classList.remove("show");
        commentInput.value = "";
        alert("저장됐어요!");
      } catch (e) {
        console.error(e);
        alert("저장 중 오류가 발생했어요. (콘솔 확인)");
      }
    });

    // 엔터로 저장
    commentInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        saveCommentBtn.click();
      }
    });

    /* =========================
       10) 초기 로딩
       ========================= */
    loadInputs();
    updateBadges();
    renderTreeFromStorage();

    (function initRoute() {
      const hasUser = (localStorage.getItem(KEY_NAME) || "").trim() && (localStorage.getItem(KEY_DEPT) || "");
      const target = screenFromHash();

      if (!hasUser && target !== 1) {
        go(1, true);
        return;
      }

      if (target === 3) {
        const savedRegion = localStorage.getItem(KEY_REGION);
        if (!savedRegion) {
          go(2, true);
          return;
        }
        openRegion(savedRegion);
        history.replaceState({ screen: 3 }, "", "#s3");
        return;
      }

      go(target, true);
    })();
  </script>
</body>
</html>
