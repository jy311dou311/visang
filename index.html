<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ë³´ë¬¼ì°¾ê¸°</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 60px 0; background:#fff; }
    .screen { display: none; }
    .screen.active { display: block; }

    input, select { padding: 10px; margin: 6px; width: 260px; max-width: 90vw; }
    button { padding: 10px 18px; margin-top: 12px; cursor: pointer; }

    .card{
      width: min(980px, 95vw);
      margin: 0 auto;
      border: 1px solid #ddd;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      background: #fff;
      text-align: left;
    }
    .title{
      display:flex; justify-content: space-between; align-items: baseline;
      gap: 10px; margin-bottom: 10px;
    }
    .badge{
      font-size: 12px; padding: 4px 10px; border-radius: 999px;
      border: 1px solid #ddd; background: #f7f7f7; white-space: nowrap;
    }
    .hint { font-size: 13px; color: #666; margin-top: 6px; }

    /* ====== Screen2: ì§€ë„ë§Œ ====== */
    .map-stage{
      position: relative;
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #eee;
      background: #fafafa;
    }
    .map-stage img{
      display: block;
      width: 100%;
      height: auto;
      user-select: none;
      -webkit-user-drag: none;
    }
    .map-stage svg{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* âœ… í´ë¦­ êµ¬ì—­ hover ê°•ì¡° */
    .region{
      fill: rgba(0,0,0,0);
      cursor: pointer;
      transition: fill 160ms ease, stroke 160ms ease, filter 160ms ease;
    }
    .region:hover{
      fill: rgba(0, 123, 255, 0.25);
      stroke: rgba(0, 123, 255, 0.9);
      stroke-width: 3;
      filter: drop-shadow(0 0 6px rgba(0,123,255,0.45));
    }

    .btn-row{
      display:flex; justify-content:center; gap: 10px;
      flex-wrap: wrap; margin-top: 12px;
    }

    .title-right{
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .reset-mini{
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .reset-mini:hover{
      background: #f6f6f6;
    }

    /* ===== Screen3: ì´ë¯¸ì§€ í”„ë ˆì„ + ìºë¦­í„° ì˜¤ë²„ë ˆì´ ===== */
    .viewer {
      display: grid;
      gap: 12px;
      place-items: center;
      text-align: center;
      padding-top: 6px;
    }
    .photoFrame{
      position: relative;
      width: 100%;
      max-width: 420px;
    }
    .viewer img#regionImage{
      width: 100%;
      max-width: 420px;
      height: 260px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #eee;
      background: #fafafa;
      transform-origin: center center;
      transition: transform 140ms ease;
      display:block;
    }

    /* âœ… ìºë¦­í„°: ì‚´ì§ í™•ëŒ€(í˜¸ë²„), ë¿Œì—° ë°°ê²½/ë™ê·¸ë¼ë¯¸ íš¨ê³¼ ì—†ìŒ */
    .characterHotspot{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(
       calc(-50% + var(--dx, 0px)),
       calc(-50% + var(--dy, 0px))
      ) scale(var(--sc, 1));
      width: 72px;
      height: 72px;
      object-fit: contain;
      cursor: pointer;
      user-select: none;
      -webkit-user-drag: none;

      background: none;
      backdrop-filter: none;
      border-radius: 0;
      box-shadow: none;

      transition: transform 120ms ease;
    }
    .characterHotspot:hover{
     transform: translate(
       calc(-50% + var(--dx, 0px)),
       calc(-50% + var(--dy, 0px))
      ) scale(calc(var(--sc, 1) * 1.03));
    }


    /* âœ… íˆ´íŒ */
    .tooltip {
      position: fixed;
      z-index: 9999;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,0.78);
      color: #fff;
      font-size: 13px;
      line-height: 1.2;
      pointer-events: none;
      opacity: 0;
      transform: translate(-50%, -120%);
      transition: opacity 80ms ease;
      white-space: nowrap;
    }
    .tooltip.show { opacity: 1; }

    /* ===== ëª¨ë‹¬ ===== */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal.show{ display: flex; }
    .modal-card{
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      width: min(360px, 90vw);
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    .modal-card input{
      width: 100%;
      padding: 10px;
      margin: 12px 0;
    }
    .modal-actions{
      display: flex;
      gap: 10px;
      justify-content: center;
    }
  </style>
</head>
<body>

  <!-- 1) ì…ë ¥ í™”ë©´ -->
  <div id="screen1" class="screen active">
    <h1>ì •ë³´ ì…ë ¥</h1>

    <input type="text" id="name" placeholder="ì´ë¦„" autocomplete="name" /><br>

    <select id="department">
      <option value="">ë¶€ì„œ ì„ íƒ</option>
      <option value="ì—ë“€í…Œí¬ì½˜í…ì¸ 1">ì—ë“€í…Œí¬ì½˜í…ì¸ 1</option>
      <option value="ë¼í‚¤ë¹„ì›€">ë¼í‚¤ë¹„ì›€</option>
      <option value="ê¸°ì¶œíƒ­íƒ­">ê¸°ì¶œíƒ­íƒ­</option>
      <option value="êµ­ì–´2">êµ­ì–´2</option>
      <option value="í‹°ì¹­ì½˜í…ì¸ ê°œë°œ3">í‹°ì¹­ì½˜í…ì¸ ê°œë°œ3</option>
    </select><br>

    <button id="nextBtn">ë‹¤ìŒ</button>
  </div>

  <!-- 2) ì§€ë„ í™”ë©´ (7êµ¬ì—­) -->
  <div id="screen2" class="screen">
    <div class="card">
      <div class="title">
         <div>
             <h2 style="margin:0">ê°ê°ì˜ êµ¬ì—­ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</h2>
             <div class="hint">êµ¬ì—­ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!</div>
         </div>

         <div class="title-right">
             <div class="badge" id="userBadge"></div>
             <button id="resetBtn" class="reset-mini">ì €ì¥ê°’ ì´ˆê¸°í™”</button>
         </div>
     </div>

      <!-- âœ… ì§€ë„ë§Œ -->
      <div class="map-stage">
        <img src="floor.png" alt="ì§€ë„">

        <svg viewBox="0 0 1536 1024" preserveAspectRatio="xMidYMid meet" aria-label="í´ë¦­ ê°€ëŠ¥í•œ 7êµ¬ì—­">
          <rect class="region" data-region="íœ´ë‹´" x="205" y="115" width="466" height="110" rx="28" ry="28"></rect>
          <rect class="region" data-region="í†µì‹¤" x="671" y="115" width="765" height="287" rx="28" ry="28"></rect>
          <rect class="region" data-region="ìŠ¤ë§ˆíŠ¸ í´ë˜ìŠ¤" x="1365" y="402" width="70" height="253" rx="28" ry="28"></rect>
          <rect class="region" data-region="ë„ì„œê´€" x="97" y="225" width="203" height="447" rx="28" ry="28"></rect>
          <rect class="region" data-region="ìŠ¤ë§ˆíŠ¸ì•„ì¹´ì´ë¸Œ" x="97" y="780" width="248" height="88" rx="28" ry="28"></rect>
          <rect class="region" data-region="êµê³¼ì„œì˜ ì—­ì‚¬" x="345" y="780" width="841" height="88" rx="28" ry="28"></rect>
          <rect class="region" data-region="ì—ë“€í…Œí¬ì¡´" x="315" y="225" width="248" height="70" rx="28" ry="28"></rect>
        </svg>
      </div>

      <div class="btn-row">
        <button id="backBtn">ë’¤ë¡œ</button>
      </div>
    </div>
  </div>

  <!-- 3) êµ¬ì—­ ìƒì„¸ í™”ë©´ -->
  <div id="screen3" class="screen">
    <div class="card">
      <div class="title">
        <div>
          <h2 style="margin:0" id="regionTitle">êµ¬ì—­</h2>
          <div class="hint" id="regionSub">ê³µê°„ì„ ì†Œê°œí•©ë‹ˆë‹¤.</div>
          <div class="hint" id="regionQuestion" style="margin-top:8px; font-weight:600; color:#333;"></div>
        </div>
        <div class="badge" id="userBadge3"></div>
      </div>

      <div class="viewer">
        <div class="photoFrame">
          <img id="regionImage" alt="ì„ íƒëœ êµ¬ì—­ ì´ë¯¸ì§€">
          <img
            id="characterHotspot"
            class="characterHotspot"
            src="character.png"
            alt="í•œ ì¤„ ì…ë ¥í•˜ê¸°"
            title="í´ë¦­í•´ì„œ í•œ ì¤„ ì…ë ¥"
          />
        </div>
      </div>

      <div class="btn-row">
        <button id="toMapBtn">ì§€ë„ ëŒì•„ê°€ê¸°</button>
      </div>
    </div>
  </div>

  <!-- íˆ´íŒ -->
  <div id="tooltip" class="tooltip"></div>

  <!-- âœ… ë‹µë³€ ì…ë ¥ ëª¨ë‹¬ -->
  <div id="commentModal" class="modal">
    <div class="modal-card">
      <h3 style="margin-top:0">ë‹µë³€ ì…ë ¥</h3>
      <div id="questionText" class="hint" style="margin-top:-6px;"></div>
      <input
        type="text"
        id="commentInput"
        placeholder="ì—¬ê¸°ì— í•œ ì¤„ë¡œ ì…ë ¥"
        maxlength="80"
      >
      <div class="modal-actions">
        <button id="saveCommentBtn">ì €ì¥</button>
        <button id="closeCommentBtn">ì·¨ì†Œ</button>
      </div>
      <div class="hint" style="margin-top:10px;">â€» ì¤‘ì•™ìˆ˜ì§‘.</div>
    </div>
  </div>

  <script type="module">
    /* =========================
       1) Firebase ì„¤ì •
       ========================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8n3EetbrAOmJ9BFy7tdSxKjwbobqOcP8",
      authDomain: "visang-find.firebaseapp.com",
      projectId: "visang-find",
      storageBucket: "visang-find.firebasestorage.app",
      messagingSenderId: "543146477593",
      appId: "1:543146477593:web:cf26b2d26ab15893d50288"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function saveCommentToFirestore(region, question, text, name, department) {
      await addDoc(collection(db, "comments"), {
        region,
        question,
        text,
        name,
        department,
        createdAt: serverTimestamp()
      });
    }

    /* =========================
       2) ì €ì¥ í‚¤ & DOM
       ========================= */
    const KEY_NAME = "saved_name";
    const KEY_DEPT = "saved_department";
    const KEY_REGION = "saved_region";

    const screen1 = document.getElementById("screen1");
    const screen2 = document.getElementById("screen2");
    const screen3 = document.getElementById("screen3");

    const nameInput = document.getElementById("name");
    const deptSelect = document.getElementById("department");

    const nextBtn = document.getElementById("nextBtn");
    const backBtn = document.getElementById("backBtn");
    const resetBtn = document.getElementById("resetBtn");
    const toMapBtn = document.getElementById("toMapBtn");

    const userBadge = document.getElementById("userBadge");
    const userBadge3 = document.getElementById("userBadge3");

    const regionTitle = document.getElementById("regionTitle");
    const regionSub = document.getElementById("regionSub");
    const regionImage = document.getElementById("regionImage");
    const regionQuestionEl = document.getElementById("regionQuestion");

    const characterHotspot = document.getElementById("characterHotspot");

    const commentModal = document.getElementById("commentModal");
    const commentInput = document.getElementById("commentInput");
    const saveCommentBtn = document.getElementById("saveCommentBtn");
    const closeCommentBtn = document.getElementById("closeCommentBtn");
    const questionText = document.getElementById("questionText");

    const regionEls = document.querySelectorAll(".region");

    /* =========================
       3) êµ¬ì—­ ë§¤í•‘
       ========================= */
    const regionToImage = {
      "íœ´ë‹´": "hudam.png",
      "í†µì‹¤": "tongsil.png",
      "ìŠ¤ë§ˆíŠ¸ í´ë˜ìŠ¤": "smart-class.png",
      "ë„ì„œê´€": "library.png",
      "ìŠ¤ë§ˆíŠ¸ì•„ì¹´ì´ë¸Œ": "archive.png",
      "êµê³¼ì„œì˜ ì—­ì‚¬": "history.png",
      "ì—ë“€í…Œí¬ì¡´": "edutech.png",
    };

    const regionToText = {
      "íœ´ë‹´": "ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
      "í†µì‹¤": "ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
      "ìŠ¤ë§ˆíŠ¸ í´ë˜ìŠ¤": "ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
      "ë„ì„œê´€": "ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
      "ìŠ¤ë§ˆíŠ¸ì•„ì¹´ì´ë¸Œ": "ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
      "êµê³¼ì„œì˜ ì—­ì‚¬": "ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
      "ì—ë“€í…Œí¬ì¡´": "ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”",
    };

    const regionToQuestion = {
      "íœ´ë‹´": "ìµœê·¼ì— â€œì´ê²Œ ì›ë˜ ì´ë ‡ê²Œ í•˜ëŠ” ê±°ì˜€ì–´?â€ í•˜ê³  ë‹¤ì‹œ ë³´ê²Œ ëœ ê²Œ ìˆë‚˜ìš”?",
      "í†µì‹¤": "ì§ì ‘ ì¨ë³´ê±°ë‚˜ ê²ªì–´ë³´ê³  ë‚˜ì„œ, ìƒê°ì´ ì¢€ ë°”ë€ ê²½í—˜ì´ ìˆë‚˜ìš”?",
      "ìŠ¤ë§ˆíŠ¸ í´ë˜ìŠ¤": "ìš”ì¦˜ ê´œíˆ ë” ì°¾ì•„ë³´ê²Œ ë˜ê±°ë‚˜, ìê¾¸ ì–˜ê¸°í•˜ê³  ì‹¶ì–´ì§€ëŠ” ê´€ì‹¬ì‚¬ê°€ ìˆë‚˜ìš”?",
      "ë„ì„œê´€": "â€œì•„ ë‚œ ì € ìƒê° ëª» í•´ë´¤ë„¤â€ ì‹¶ì—ˆë˜ ë§ì´ë‚˜ ì˜ê²¬ì„ ë“¤ì€ ì  ìˆë‚˜ìš”?",
      "ìŠ¤ë§ˆíŠ¸ì•„ì¹´ì´ë¸Œ": "ëˆ„ê°€ íˆ­ ë˜ì§„ ë§ì¸ë°, ì€ê·¼íˆ ë„ì›€ ëë˜ ì  ìˆë‚˜ìš”?",
      "êµê³¼ì„œì˜ ì—­ì‚¬": "ìš”ì¦˜ â€œì•„ ì´ë˜ì„œ ì´ íšŒì‚¬ ë‹¤ë‹ˆì§€â€ ì‹¶ì—ˆë˜ ìˆœê°„ì´ ìˆë‚˜ìš”?",
      "ì—ë“€í…Œí¬ì¡´": "ìµœê·¼ì— ê³ ë¯¼ ë§ì´ í•´ì„œ â€œì™€ ì´ê±´ ì˜ ìƒ€ë‹¤ / ì˜ í–ˆë‹¤â€ ì‹¶ì€ ì„ íƒì´ ìˆë‚˜ìš”?",
    };

    const regionToCharacterImage = {
     "íœ´ë‹´": "character-hudam.png",
     "í†µì‹¤": "character-tongsil.png",
     "ìŠ¤ë§ˆíŠ¸ í´ë˜ìŠ¤": "character-smartclass.png",
     "ë„ì„œê´€": "character-library.png",
     "ìŠ¤ë§ˆíŠ¸ì•„ì¹´ì´ë¸Œ": "character-archive.png",
     "êµê³¼ì„œì˜ ì—­ì‚¬": "character-history.png",
     "ì—ë“€í…Œí¬ì¡´": "character-edutech.png",
    };

    const DEFAULT_CHARACTER_IMAGE = "character.png";

    const regionRotation = {
      "íœ´ë‹´": 0, "í†µì‹¤": 0, "ìŠ¤ë§ˆíŠ¸ í´ë˜ìŠ¤": 0, "ë„ì„œê´€": 0,
      "ìŠ¤ë§ˆíŠ¸ì•„ì¹´ì´ë¸Œ": 0, "êµê³¼ì„œì˜ ì—­ì‚¬": 0, "ì—ë“€í…Œí¬ì¡´": 0,
    };

    // ìºë¦­í„° ìœ„ì¹˜
    const regionToCharacterPos = {
      "íœ´ë‹´": { x: 50, y: 70 },
      "í†µì‹¤": { x: 50, y: 50 },
      "ìŠ¤ë§ˆíŠ¸ í´ë˜ìŠ¤": { x: 10, y: 80 },
      "ë„ì„œê´€": { x: 80, y: 60 },
      "ìŠ¤ë§ˆíŠ¸ì•„ì¹´ì´ë¸Œ": { x: 20, y: 50 },
      "êµê³¼ì„œì˜ ì—­ì‚¬": { x: 50, y: 30 },
      "ì—ë“€í…Œí¬ì¡´": { x: 30, y: 70 },
    };

    // âœ… êµ¬ì—­ë³„ ë¯¸ì„¸ ì˜¤í”„ì…‹(px) : +dxëŠ” ì˜¤ë¥¸ìª½, +dyëŠ” ì•„ë˜ë¡œ
    const regionToCharacterOffset = {
     "íœ´ë‹´": { dx: 14, dy: 5 },
     "í†µì‹¤": { dx: 0, dy: 0 },
     "ìŠ¤ë§ˆíŠ¸ í´ë˜ìŠ¤": { dx: 0, dy: 0 },
     "ë„ì„œê´€": { dx: -3, dy: 0 },
     "ìŠ¤ë§ˆíŠ¸ì•„ì¹´ì´ë¸Œ": { dx: 4, dy: 8 },
     "êµê³¼ì„œì˜ ì—­ì‚¬": { dx: 3, dy: 5 },
     "ì—ë“€í…Œí¬ì¡´": { dx: 7, dy: 0 },
    };

    // âœ… êµ¬ì—­ë³„ ìºë¦­í„° í¬ê¸° ë°°ìœ¨
    const regionToCharacterScale = {
     "íœ´ë‹´": 1.0,
     "í†µì‹¤": 1.0,
     "ìŠ¤ë§ˆíŠ¸ í´ë˜ìŠ¤": 1.0,
     "ë„ì„œê´€": 2.0,        // ğŸ‘ˆ ì—¬ê¸°!
     "ìŠ¤ë§ˆíŠ¸ì•„ì¹´ì´ë¸Œ": 1.0,
     "êµê³¼ì„œì˜ ì—­ì‚¬": 1.0,
     "ì—ë“€í…Œí¬ì¡´": 1.0,
    };


    /* =========================
       4) ë¼ìš°íŒ…(ë’¤ë¡œê°€ê¸°)
       ========================= */
    function renderScreen(n) {
      screen1.classList.toggle("active", n === 1);
      screen2.classList.toggle("active", n === 2);
      screen3.classList.toggle("active", n === 3);
    }

    function go(screenNum, replace = false) {
      const state = { screen: screenNum };
      const url = `#s${screenNum}`;
      if (replace) history.replaceState(state, "", url);
      else history.pushState(state, "", url);
      renderScreen(screenNum);
    }

    function screenFromHash() {
      const h = (location.hash || "").toLowerCase();
      if (h === "#s2") return 2;
      if (h === "#s3") return 3;
      return 1;
    }

    window.addEventListener("popstate", () => {
      renderScreen(screenFromHash());
    });

    /* =========================
       5) ê¸°ë³¸ ì €ì¥/ë¡œë”©
       ========================= */
    function saveInputs(name, dept) {
      localStorage.setItem(KEY_NAME, name);
      localStorage.setItem(KEY_DEPT, dept);
    }

    function loadInputs() {
      const savedName = localStorage.getItem(KEY_NAME) || "";
      const savedDept = localStorage.getItem(KEY_DEPT) || "";
      if (savedName) nameInput.value = savedName;
      if (savedDept) deptSelect.value = savedDept;
    }

    function updateBadges() {
      const n = (localStorage.getItem(KEY_NAME) || "").trim();
      const d = localStorage.getItem(KEY_DEPT) || "";
      const text = (n && d) ? `${n} Â· ${d}` : "";
      userBadge.textContent = text;
      userBadge3.textContent = text;
    }

    function nextScreen() {
      const name = nameInput.value.trim();
      const dept = deptSelect.value;

      if (!name || !dept) {
        alert("ì´ë¦„ê³¼ ë¶€ì„œë¥¼ ëª¨ë‘ ì…ë ¥/ì„ íƒí•´ì£¼ì„¸ìš”!");
        return;
      }

      saveInputs(name, dept);
      updateBadges();
      go(2);
    }

    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") nextScreen();
    });
    deptSelect.addEventListener("keydown", (e) => {
      if (e.key === "Enter") nextScreen();
    });

    function openRegion(regionName) {
      localStorage.setItem(KEY_REGION, regionName);

      const imgSrc = regionToImage[regionName];
      regionTitle.textContent = regionName;
      regionSub.textContent = regionToText[regionName] || `${regionName} ê³µê°„ì„ ì†Œê°œí•©ë‹ˆë‹¤.`;

      const q = regionToQuestion[regionName] || "ì´ ê³µê°„ì— ëŒ€í•œ í•œ ì¤„ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.";
      regionQuestionEl.textContent = `ì§ˆë¬¸: ${q}`;

      if (imgSrc) {
        regionImage.src = imgSrc;
        regionImage.alt = `${regionName} ì´ë¯¸ì§€`;
        const deg = regionRotation[regionName] ?? 0;
        regionImage.style.transform = `rotate(${deg}deg)`;
      } else {
        regionImage.removeAttribute("src");
        regionImage.alt = "ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.";
        regionImage.style.transform = "rotate(0deg)";
      }


      const charSrc = regionToCharacterImage[regionName] || DEFAULT_CHARACTER_IMAGE;
      characterHotspot.src = charSrc;

      // ìºë¦­í„° ìœ„ì¹˜ ì ìš©(í˜„ì¬ ì¤‘ì•™)
      const pos = regionToCharacterPos[regionName] || { x: 50, y: 50 };
      characterHotspot.style.left = `${pos.x}%`;
      characterHotspot.style.top = `${pos.y}%`;

      // âœ… ë¯¸ì„¸ ì˜¤í”„ì…‹(px) ì ìš©
      const off = regionToCharacterOffset[regionName] || { dx: 0, dy: 0 };
      characterHotspot.style.setProperty("--dx", `${off.dx}px`);
      characterHotspot.style.setProperty("--dy", `${off.dy}px`);

      updateBadges();
      go(3);
    }

    function resetAll() {
      localStorage.removeItem(KEY_NAME);
      localStorage.removeItem(KEY_DEPT);
      localStorage.removeItem(KEY_REGION);
      nameInput.value = "";
      deptSelect.value = "";
      alert("ì €ì¥ëœ ê°’ì´ ì´ˆê¸°í™”ëì–´ìš”!");
      go(1, true);
    }

    nextBtn.addEventListener("click", nextScreen);
    backBtn.addEventListener("click", () => go(1));
    toMapBtn.addEventListener("click", () => go(2));
    resetBtn.addEventListener("click", resetAll);

    regionEls.forEach(el => {
      el.addEventListener("click", () => openRegion(el.dataset.region));
    });

    /* =========================
       6) íˆ´íŒ(ì¥ì†Œëª…)
       ========================= */
    const tooltip = document.getElementById("tooltip");
    function showTooltip(text, clientX, clientY) {
      tooltip.textContent = text;
      tooltip.style.left = `${clientX}px`;
      tooltip.style.top = `${clientY}px`;
      tooltip.classList.add("show");
    }
    function moveTooltip(clientX, clientY) {
      tooltip.style.left = `${clientX}px`;
      tooltip.style.top = `${clientY}px`;
    }
    function hideTooltip() {
      tooltip.classList.remove("show");
    }

    regionEls.forEach(el => {
      const name = el.dataset.region;

      el.addEventListener("mouseenter", (e) => showTooltip(name, e.clientX, e.clientY));
      el.addEventListener("mousemove", (e) => moveTooltip(e.clientX, e.clientY));
      el.addEventListener("mouseleave", hideTooltip);

      el.addEventListener("touchstart", (e) => {
        const t = e.touches[0];
        showTooltip(name, t.clientX, t.clientY);
        setTimeout(hideTooltip, 900);
      }, { passive: true });
    });

    window.addEventListener("scroll", hideTooltip, { passive: true });
    window.addEventListener("resize", hideTooltip);

    /* =========================
       7) í”½ì…€ í¼í™íŠ¸ í´ë¦­(íˆ¬ëª… ì˜ì—­ ë¬´ì‹œ)
       ========================= */
    function makePixelPerfectClickable(imgEl, onHit) {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      function drawToCanvas() {
        const w = imgEl.naturalWidth;
        const h = imgEl.naturalHeight;
        if (!w || !h) return false;
        canvas.width = w;
        canvas.height = h;
        ctx.clearRect(0, 0, w, h);
        ctx.drawImage(imgEl, 0, 0);
        return true;
      }

      if (imgEl.complete) drawToCanvas();
      imgEl.addEventListener("load", drawToCanvas);

      imgEl.addEventListener("pointerdown", (e) => {
        const rect = imgEl.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) * (imgEl.naturalWidth / rect.width));
        const y = Math.floor((e.clientY - rect.top) * (imgEl.naturalHeight / rect.height));

        if (x < 0 || y < 0 || x >= imgEl.naturalWidth || y >= imgEl.naturalHeight) return;
        if (!imgEl.naturalWidth || !imgEl.naturalHeight) return;

        const pixel = ctx.getImageData(x, y, 1, 1).data;
        const alpha = pixel[3];

        if (alpha > 20) onHit(e);
      });
    }

    /* =========================
       8) ëª¨ë‹¬(ìºë¦­í„° í´ë¦­ â†’ ì…ë ¥)
       ========================= */
    function openCommentModal(){
      const region = localStorage.getItem(KEY_REGION);
      if (!region) return;

      const q = regionToQuestion[region] || "ì´ ê³µê°„ì— ëŒ€í•œ í•œ ì¤„ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.";
      questionText.textContent = q;

      commentInput.value = "";
      commentModal.classList.add("show");
      commentInput.focus();
    }

    makePixelPerfectClickable(characterHotspot, () => {
      openCommentModal();
    });

    closeCommentBtn.addEventListener("click", () => {
      commentModal.classList.remove("show");
    });

    commentModal.addEventListener("click", (e) => {
      if (e.target === commentModal) commentModal.classList.remove("show");
    });

    saveCommentBtn.addEventListener("click", async () => {
      const region = localStorage.getItem(KEY_REGION);
      const text = commentInput.value.trim();

      if (!text) {
        alert("ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }

      const name = (localStorage.getItem(KEY_NAME) || "ìµëª…").trim();
      const department = localStorage.getItem(KEY_DEPT) || "";
      const question = regionToQuestion[region] || "ì´ ê³µê°„ì— ëŒ€í•œ í•œ ì¤„ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.";

      try {
        await saveCommentToFirestore(region, question, text, name, department);

        commentModal.classList.remove("show");
        commentInput.value = "";
        alert("ì €ì¥ëì–´ìš”!");
      } catch (e) {
        console.error(e);
        alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. (ì½˜ì†” í™•ì¸)");
      }
    });

    commentInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        saveCommentBtn.click();
      }
    });

    /* =========================
       9) ì´ˆê¸° ë¡œë”©
       ========================= */
    loadInputs();
    updateBadges();

    (function initRoute() {
      const hasUser = (localStorage.getItem(KEY_NAME) || "").trim() && (localStorage.getItem(KEY_DEPT) || "");
      const target = screenFromHash();

      if (!hasUser && target !== 1) {
        go(1, true);
        return;
      }

      if (target === 3) {
        const savedRegion = localStorage.getItem(KEY_REGION);
        if (!savedRegion) {
          go(2, true);
          return;
        }
        openRegion(savedRegion);
        history.replaceState({ screen: 3 }, "", "#s3");
        return;
      }

      go(target, true);
    })();
  </script>
</body>
</html>
