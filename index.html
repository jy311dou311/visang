<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>보물찾기</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 60px 0; background:#fff; }
    .screen { display: none; }
    .screen.active { display: block; }

    input, select { padding: 10px; margin: 6px; width: 260px; max-width: 90vw; }
    button { padding: 10px 18px; margin-top: 12px; cursor: pointer; }

    .card{
      width: min(980px, 95vw);
      margin: 0 auto;
      border: 1px solid #ddd;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      background: #fff;
      text-align: left;
    }
    .title{
      display:flex; justify-content: space-between; align-items: baseline;
      gap: 10px; margin-bottom: 10px;
    }
    .badge{
      font-size: 12px; padding: 4px 10px; border-radius: 999px;
      border: 1px solid #ddd; background: #f7f7f7; white-space: nowrap;
    }
    .hint { font-size: 13px; color: #666; margin-top: 6px; }

    /* ====== Screen2: 지도만 ====== */
    .map-stage{
      position: relative;
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #eee;
      background: #fafafa;
    }
    .map-stage img{
      display: block;
      width: 100%;
      height: auto;
      user-select: none;
      -webkit-user-drag: none;
    }
    .map-stage svg{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* ✅ 클릭 구역 hover 강조 */
    .region{
      fill: rgba(0,0,0,0);
      cursor: pointer;
      transition: fill 160ms ease, stroke 160ms ease, filter 160ms ease;
    }
    .region:hover{
      fill: rgba(0, 123, 255, 0.25);
      stroke: rgba(0, 123, 255, 0.9);
      stroke-width: 3;
      filter: drop-shadow(0 0 6px rgba(0,123,255,0.45));
    }

    .btn-row{
      display:flex; justify-content:center; gap: 10px;
      flex-wrap: wrap; margin-top: 12px;
    }

    .title-right{
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .reset-mini{
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .reset-mini:hover{
      background: #f6f6f6;
    }

    /* ===== Screen3: 이미지 프레임 + 캐릭터 오버레이 ===== */
    .viewer {
      display: grid;
      gap: 12px;
      place-items: center;
      text-align: center;
      padding-top: 6px;
    }
    .photoFrame{
      position: relative;
      width: 100%;
      max-width: 420px;
    }
    .viewer img#regionImage{
      width: 100%;
      max-width: 420px;
      height: 260px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #eee;
      background: #fafafa;
      transform-origin: center center;
      transition: transform 140ms ease;
      display:block;
    }

    /* ✅ 캐릭터: 살짝 확대(호버), 뿌연 배경/동그라미 효과 없음 */
    .characterHotspot{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px))) scale(1);
      width: 72px;
      height: 72px;
      object-fit: contain;
      cursor: pointer;
      user-select: none;
      -webkit-user-drag: none;

      background: none;
      backdrop-filter: none;
      border-radius: 0;
      box-shadow: none;

      transition: transform 120ms ease;
    }
    .characterHotspot:hover{
     transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px))) scale(1.03);
    }

    /* ✅ 툴팁 */
    .tooltip {
      position: fixed;
      z-index: 9999;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,0.78);
      color: #fff;
      font-size: 13px;
      line-height: 1.2;
      pointer-events: none;
      opacity: 0;
      transform: translate(-50%, -120%);
      transition: opacity 80ms ease;
      white-space: nowrap;
    }
    .tooltip.show { opacity: 1; }

    /* ===== 모달 ===== */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal.show{ display: flex; }
    .modal-card{
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      width: min(360px, 90vw);
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    .modal-card input{
      width: 100%;
      padding: 10px;
      margin: 12px 0;
    }
    .modal-actions{
      display: flex;
      gap: 10px;
      justify-content: center;
    }
  </style>
</head>
<body>

  <!-- 1) 입력 화면 -->
  <div id="screen1" class="screen active">
    <h1>정보 입력</h1>

    <input type="text" id="name" placeholder="이름" autocomplete="name" /><br>

    <select id="department">
      <option value="">부서 선택</option>
      <option value="에듀테크콘텐츠1">에듀테크콘텐츠1</option>
      <option value="라키비움">라키비움</option>
      <option value="기출탭탭">기출탭탭</option>
      <option value="국어2">국어2</option>
      <option value="티칭콘텐츠개발3">티칭콘텐츠개발3</option>
    </select><br>

    <button id="nextBtn">다음</button>
  </div>

  <!-- 2) 지도 화면 (7구역) -->
  <div id="screen2" class="screen">
    <div class="card">
      <div class="title">
         <div>
             <h2 style="margin:0">각각의 구역을 눌러보세요!</h2>
             <div class="hint">구역을 눌러주세요!</div>
         </div>

         <div class="title-right">
             <div class="badge" id="userBadge"></div>
             <button id="resetBtn" class="reset-mini">저장값 초기화</button>
         </div>
     </div>

      <!-- ✅ 지도만 -->
      <div class="map-stage">
        <img src="floor.png" alt="지도">

        <svg viewBox="0 0 1536 1024" preserveAspectRatio="xMidYMid meet" aria-label="클릭 가능한 7구역">
          <rect class="region" data-region="휴담" x="205" y="115" width="466" height="110" rx="28" ry="28"></rect>
          <rect class="region" data-region="통실" x="671" y="115" width="765" height="287" rx="28" ry="28"></rect>
          <rect class="region" data-region="스마트 클래스" x="1365" y="402" width="70" height="253" rx="28" ry="28"></rect>
          <rect class="region" data-region="도서관" x="97" y="225" width="203" height="447" rx="28" ry="28"></rect>
          <rect class="region" data-region="스마트아카이브" x="97" y="780" width="248" height="88" rx="28" ry="28"></rect>
          <rect class="region" data-region="교과서의 역사" x="345" y="780" width="841" height="88" rx="28" ry="28"></rect>
          <rect class="region" data-region="에듀테크존" x="315" y="225" width="248" height="70" rx="28" ry="28"></rect>
        </svg>
      </div>

      <div class="btn-row">
        <button id="backBtn">뒤로</button>
      </div>
    </div>
  </div>

  <!-- 3) 구역 상세 화면 -->
  <div id="screen3" class="screen">
    <div class="card">
      <div class="title">
        <div>
          <h2 style="margin:0" id="regionTitle">구역</h2>
          <div class="hint" id="regionSub">공간을 소개합니다.</div>
          <div class="hint" id="regionQuestion" style="margin-top:8px; font-weight:600; color:#333;"></div>
        </div>
        <div class="badge" id="userBadge3"></div>
      </div>

      <div class="viewer">
        <div class="photoFrame">
          <img id="regionImage" alt="선택된 구역 이미지">
          <img
            id="characterHotspot"
            class="characterHotspot"
            src="character.png"
            alt="한 줄 입력하기"
            title="클릭해서 한 줄 입력"
          />
        </div>
      </div>

      <div class="btn-row">
        <button id="toMapBtn">지도 돌아가기</button>
      </div>
    </div>
  </div>

  <!-- 툴팁 -->
  <div id="tooltip" class="tooltip"></div>

  <!-- ✅ 답변 입력 모달 -->
  <div id="commentModal" class="modal">
    <div class="modal-card">
      <h3 style="margin-top:0">답변 입력</h3>
      <div id="questionText" class="hint" style="margin-top:-6px;"></div>
      <input
        type="text"
        id="commentInput"
        placeholder="여기에 한 줄로 입력"
        maxlength="80"
      >
      <div class="modal-actions">
        <button id="saveCommentBtn">저장</button>
        <button id="closeCommentBtn">취소</button>
      </div>
      <div class="hint" style="margin-top:10px;">※ 중앙수집.</div>
    </div>
  </div>

  <script type="module">
    /* =========================
       1) Firebase 설정
       ========================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8n3EetbrAOmJ9BFy7tdSxKjwbobqOcP8",
      authDomain: "visang-find.firebaseapp.com",
      projectId: "visang-find",
      storageBucket: "visang-find.firebasestorage.app",
      messagingSenderId: "543146477593",
      appId: "1:543146477593:web:cf26b2d26ab15893d50288"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function saveCommentToFirestore(region, question, text, name, department) {
      await addDoc(collection(db, "comments"), {
        region,
        question,
        text,
        name,
        department,
        createdAt: serverTimestamp()
      });
    }

    /* =========================
       2) 저장 키 & DOM
       ========================= */
    const KEY_NAME = "saved_name";
    const KEY_DEPT = "saved_department";
    const KEY_REGION = "saved_region";

    const screen1 = document.getElementById("screen1");
    const screen2 = document.getElementById("screen2");
    const screen3 = document.getElementById("screen3");

    const nameInput = document.getElementById("name");
    const deptSelect = document.getElementById("department");

    const nextBtn = document.getElementById("nextBtn");
    const backBtn = document.getElementById("backBtn");
    const resetBtn = document.getElementById("resetBtn");
    const toMapBtn = document.getElementById("toMapBtn");

    const userBadge = document.getElementById("userBadge");
    const userBadge3 = document.getElementById("userBadge3");

    const regionTitle = document.getElementById("regionTitle");
    const regionSub = document.getElementById("regionSub");
    const regionImage = document.getElementById("regionImage");
    const regionQuestionEl = document.getElementById("regionQuestion");

    const characterHotspot = document.getElementById("characterHotspot");

    const commentModal = document.getElementById("commentModal");
    const commentInput = document.getElementById("commentInput");
    const saveCommentBtn = document.getElementById("saveCommentBtn");
    const closeCommentBtn = document.getElementById("closeCommentBtn");
    const questionText = document.getElementById("questionText");

    const regionEls = document.querySelectorAll(".region");

    /* =========================
       3) 구역 매핑
       ========================= */
    const regionToImage = {
      "휴담": "hudam.png",
      "통실": "tongsil.png",
      "스마트 클래스": "smart-class.png",
      "도서관": "library.png",
      "스마트아카이브": "archive.png",
      "교과서의 역사": "history.png",
      "에듀테크존": "edutech.png",
    };

    const regionToText = {
      "휴담": "문구를 입력하세요",
      "통실": "문구를 입력하세요",
      "스마트 클래스": "문구를 입력하세요",
      "도서관": "문구를 입력하세요",
      "스마트아카이브": "문구를 입력하세요",
      "교과서의 역사": "문구를 입력하세요",
      "에듀테크존": "문구를 입력하세요",
    };

    const regionToQuestion = {
      "휴담": "최근에 “이게 원래 이렇게 하는 거였어?” 하고 다시 보게 된 게 있나요?",
      "통실": "직접 써보거나 겪어보고 나서, 생각이 좀 바뀐 경험이 있나요?",
      "스마트 클래스": "요즘 괜히 더 찾아보게 되거나, 자꾸 얘기하고 싶어지는 관심사가 있나요?",
      "도서관": "“아 난 저 생각 못 해봤네” 싶었던 말이나 의견을 들은 적 있나요?",
      "스마트아카이브": "누가 툭 던진 말인데, 은근히 도움 됐던 적 있나요?",
      "교과서의 역사": "요즘 “아 이래서 이 회사 다니지” 싶었던 순간이 있나요?",
      "에듀테크존": "최근에 고민 많이 해서 “와 이건 잘 샀다 / 잘 했다” 싶은 선택이 있나요?",
    };

    const regionToCharacterImage = {
     "휴담": "character-hudam.png",
     "통실": "character-tongsil.png",
     "스마트 클래스": "character-smartclass.png",
     "도서관": "character-library.png",
     "스마트아카이브": "character-archive.png",
     "교과서의 역사": "character-history.png",
     "에듀테크존": "character-edutech.png",
    };

    const DEFAULT_CHARACTER_IMAGE = "character.png";

    const regionRotation = {
      "휴담": 0, "통실": 0, "스마트 클래스": 0, "도서관": 0,
      "스마트아카이브": 0, "교과서의 역사": 0, "에듀테크존": 0,
    };

    // 캐릭터 위치
    const regionToCharacterPos = {
      "휴담": { x: 50, y: 70 },
      "통실": { x: 50, y: 50 },
      "스마트 클래스": { x: 50, y: 50 },
      "도서관": { x: 70, y: 50 },
      "스마트아카이브": { x: 20, y: 60 },
      "교과서의 역사": { x: 50, y: 30 },
      "에듀테크존": { x: 30, y: 60 },
    };

    // ✅ 구역별 미세 오프셋(px) : +dx는 오른쪽, +dy는 아래로
    const regionToCharacterOffset = {
     "휴담": { dx: 14, dy: 5 },
     "통실": { dx: 0, dy: 0 },
     "스마트 클래스": { dx: 0, dy: 0 },
     "도서관": { dx: 0, dy: 0 },
     "스마트아카이브": { dx: 0, dy: 0 },
     "교과서의 역사": { dx: 0, dy: 0 },
     "에듀테크존": { dx: 0, dy: 0 },
    };

    /* =========================
       4) 라우팅(뒤로가기)
       ========================= */
    function renderScreen(n) {
      screen1.classList.toggle("active", n === 1);
      screen2.classList.toggle("active", n === 2);
      screen3.classList.toggle("active", n === 3);
    }

    function go(screenNum, replace = false) {
      const state = { screen: screenNum };
      const url = `#s${screenNum}`;
      if (replace) history.replaceState(state, "", url);
      else history.pushState(state, "", url);
      renderScreen(screenNum);
    }

    function screenFromHash() {
      const h = (location.hash || "").toLowerCase();
      if (h === "#s2") return 2;
      if (h === "#s3") return 3;
      return 1;
    }

    window.addEventListener("popstate", () => {
      renderScreen(screenFromHash());
    });

    /* =========================
       5) 기본 저장/로딩
       ========================= */
    function saveInputs(name, dept) {
      localStorage.setItem(KEY_NAME, name);
      localStorage.setItem(KEY_DEPT, dept);
    }

    function loadInputs() {
      const savedName = localStorage.getItem(KEY_NAME) || "";
      const savedDept = localStorage.getItem(KEY_DEPT) || "";
      if (savedName) nameInput.value = savedName;
      if (savedDept) deptSelect.value = savedDept;
    }

    function updateBadges() {
      const n = (localStorage.getItem(KEY_NAME) || "").trim();
      const d = localStorage.getItem(KEY_DEPT) || "";
      const text = (n && d) ? `${n} · ${d}` : "";
      userBadge.textContent = text;
      userBadge3.textContent = text;
    }

    function nextScreen() {
      const name = nameInput.value.trim();
      const dept = deptSelect.value;

      if (!name || !dept) {
        alert("이름과 부서를 모두 입력/선택해주세요!");
        return;
      }

      saveInputs(name, dept);
      updateBadges();
      go(2);
    }

    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") nextScreen();
    });
    deptSelect.addEventListener("keydown", (e) => {
      if (e.key === "Enter") nextScreen();
    });

    function openRegion(regionName) {
      localStorage.setItem(KEY_REGION, regionName);

      const imgSrc = regionToImage[regionName];
      regionTitle.textContent = regionName;
      regionSub.textContent = regionToText[regionName] || `${regionName} 공간을 소개합니다.`;

      const q = regionToQuestion[regionName] || "이 공간에 대한 한 줄을 남겨주세요.";
      regionQuestionEl.textContent = `질문: ${q}`;

      if (imgSrc) {
        regionImage.src = imgSrc;
        regionImage.alt = `${regionName} 이미지`;
        const deg = regionRotation[regionName] ?? 0;
        regionImage.style.transform = `rotate(${deg}deg)`;
      } else {
        regionImage.removeAttribute("src");
        regionImage.alt = "이미지가 없습니다.";
        regionImage.style.transform = "rotate(0deg)";
      }


      const charSrc = regionToCharacterImage[regionName] || DEFAULT_CHARACTER_IMAGE;
      characterHotspot.src = charSrc;

      // 캐릭터 위치 적용(현재 중앙)
      const pos = regionToCharacterPos[regionName] || { x: 50, y: 50 };
      characterHotspot.style.left = `${pos.x}%`;
      characterHotspot.style.top = `${pos.y}%`;

      // ✅ 미세 오프셋(px) 적용
      const off = regionToCharacterOffset[regionName] || { dx: 0, dy: 0 };
      characterHotspot.style.setProperty("--dx", `${off.dx}px`);
      characterHotspot.style.setProperty("--dy", `${off.dy}px`);

      updateBadges();
      go(3);
    }

    function resetAll() {
      localStorage.removeItem(KEY_NAME);
      localStorage.removeItem(KEY_DEPT);
      localStorage.removeItem(KEY_REGION);
      nameInput.value = "";
      deptSelect.value = "";
      alert("저장된 값이 초기화됐어요!");
      go(1, true);
    }

    nextBtn.addEventListener("click", nextScreen);
    backBtn.addEventListener("click", () => go(1));
    toMapBtn.addEventListener("click", () => go(2));
    resetBtn.addEventListener("click", resetAll);

    regionEls.forEach(el => {
      el.addEventListener("click", () => openRegion(el.dataset.region));
    });

    /* =========================
       6) 툴팁(장소명)
       ========================= */
    const tooltip = document.getElementById("tooltip");
    function showTooltip(text, clientX, clientY) {
      tooltip.textContent = text;
      tooltip.style.left = `${clientX}px`;
      tooltip.style.top = `${clientY}px`;
      tooltip.classList.add("show");
    }
    function moveTooltip(clientX, clientY) {
      tooltip.style.left = `${clientX}px`;
      tooltip.style.top = `${clientY}px`;
    }
    function hideTooltip() {
      tooltip.classList.remove("show");
    }

    regionEls.forEach(el => {
      const name = el.dataset.region;

      el.addEventListener("mouseenter", (e) => showTooltip(name, e.clientX, e.clientY));
      el.addEventListener("mousemove", (e) => moveTooltip(e.clientX, e.clientY));
      el.addEventListener("mouseleave", hideTooltip);

      el.addEventListener("touchstart", (e) => {
        const t = e.touches[0];
        showTooltip(name, t.clientX, t.clientY);
        setTimeout(hideTooltip, 900);
      }, { passive: true });
    });

    window.addEventListener("scroll", hideTooltip, { passive: true });
    window.addEventListener("resize", hideTooltip);

    /* =========================
       7) 픽셀 퍼펙트 클릭(투명 영역 무시)
       ========================= */
    function makePixelPerfectClickable(imgEl, onHit) {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      function drawToCanvas() {
        const w = imgEl.naturalWidth;
        const h = imgEl.naturalHeight;
        if (!w || !h) return false;
        canvas.width = w;
        canvas.height = h;
        ctx.clearRect(0, 0, w, h);
        ctx.drawImage(imgEl, 0, 0);
        return true;
      }

      if (imgEl.complete) drawToCanvas();
      imgEl.addEventListener("load", drawToCanvas);

      imgEl.addEventListener("pointerdown", (e) => {
        const rect = imgEl.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) * (imgEl.naturalWidth / rect.width));
        const y = Math.floor((e.clientY - rect.top) * (imgEl.naturalHeight / rect.height));

        if (x < 0 || y < 0 || x >= imgEl.naturalWidth || y >= imgEl.naturalHeight) return;
        if (!imgEl.naturalWidth || !imgEl.naturalHeight) return;

        const pixel = ctx.getImageData(x, y, 1, 1).data;
        const alpha = pixel[3];

        if (alpha > 20) onHit(e);
      });
    }

    /* =========================
       8) 모달(캐릭터 클릭 → 입력)
       ========================= */
    function openCommentModal(){
      const region = localStorage.getItem(KEY_REGION);
      if (!region) return;

      const q = regionToQuestion[region] || "이 공간에 대한 한 줄을 남겨주세요.";
      questionText.textContent = q;

      commentInput.value = "";
      commentModal.classList.add("show");
      commentInput.focus();
    }

    makePixelPerfectClickable(characterHotspot, () => {
      openCommentModal();
    });

    closeCommentBtn.addEventListener("click", () => {
      commentModal.classList.remove("show");
    });

    commentModal.addEventListener("click", (e) => {
      if (e.target === commentModal) commentModal.classList.remove("show");
    });

    saveCommentBtn.addEventListener("click", async () => {
      const region = localStorage.getItem(KEY_REGION);
      const text = commentInput.value.trim();

      if (!text) {
        alert("답변을 입력해주세요!");
        return;
      }

      const name = (localStorage.getItem(KEY_NAME) || "익명").trim();
      const department = localStorage.getItem(KEY_DEPT) || "";
      const question = regionToQuestion[region] || "이 공간에 대한 한 줄을 남겨주세요.";

      try {
        await saveCommentToFirestore(region, question, text, name, department);

        commentModal.classList.remove("show");
        commentInput.value = "";
        alert("저장됐어요!");
      } catch (e) {
        console.error(e);
        alert("저장 중 오류가 발생했어요. (콘솔 확인)");
      }
    });

    commentInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        saveCommentBtn.click();
      }
    });

    /* =========================
       9) 초기 로딩
       ========================= */
    loadInputs();
    updateBadges();

    (function initRoute() {
      const hasUser = (localStorage.getItem(KEY_NAME) || "").trim() && (localStorage.getItem(KEY_DEPT) || "");
      const target = screenFromHash();

      if (!hasUser && target !== 1) {
        go(1, true);
        return;
      }

      if (target === 3) {
        const savedRegion = localStorage.getItem(KEY_REGION);
        if (!savedRegion) {
          go(2, true);
          return;
        }
        openRegion(savedRegion);
        history.replaceState({ screen: 3 }, "", "#s3");
        return;
      }

      go(target, true);
    })();
  </script>
</body>
</html>
