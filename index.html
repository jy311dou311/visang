<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>비버샘과 가치나누기</title>

  <style>
    :root{
      --bg: #F6F8FB;
      --surface: #FFFFFF;
      --text: #111827;
      --muted: #6B7280;
      --border: rgba(17,24,39,0.10);
      --shadow: 0 14px 40px rgba(17,24,39,0.08);

      --primary: #2563EB;         /* blue */
      --primary-weak: rgba(37,99,235,0.10);
      --primary-strong: rgba(37,99,235,0.18);

      --danger: #EF4444;

      --radius-xl: 20px;
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;

      --maxw: 1100px;
    }

    *{ box-sizing: border-box; }
    html,body{ height: 100%; }
    body{
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo",
                   "Noto Sans KR", "Malgun Gothic", Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(37,99,235,0.10), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(37,99,235,0.07), transparent 55%),
                  var(--bg);
    }

    /* 래이아웃 */
    .screen { display: none; }
    .screen.active { display: block; }

    .container{
      width: min(var(--maxw), 92vw);
      margin: 28px auto 48px;
    }

    /* 위에 바 */
    .brandbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 2px 18px;
    }
    .brand{
      display:flex; align-items:center; gap: 10px;
      user-select:none;
    }
    .brandMark{
      width: 36px; height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(37,99,235,0.95), rgba(37,99,235,0.65));
      box-shadow: 0 10px 24px rgba(37,99,235,0.25);
    }
    .brandText{
      display:flex; flex-direction: column; line-height: 1.1;
    }
    .brandText .t1{ font-weight: 800; letter-spacing: -0.2px; }
    .brandText .t2{ color: var(--muted); font-size: 12px; margin-top: 2px; }

    .pill{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.8);
      border: 1px solid var(--border);
      box-shadow: 0 10px 20px rgba(17,24,39,0.06);
      backdrop-filter: blur(6px);
      font-size: 13px;
      color: var(--text);
      white-space: nowrap;
    }

    .section{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .sectionHead{
      padding: 18px 20px;
      display:flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(37,99,235,0.06), transparent 55%);
    }

    .hTitle{
      margin:0;
      font-size: 26px;
      letter-spacing: -0.4px;
    }
    .hDesc{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    .hDesc.oneLine {
     white-space: nowrap;
     overflow: hidden;
     text-overflow: ellipsis;
    }
    .rightCol{
      display:flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 10px;
    }

    .field{
      width: min(420px, 92vw);
      margin: 0 auto;
      padding: 22px 18px 24px;
    }

    .label{
      text-align:left;
      font-size: 13px;
      color: var(--muted);
      margin: 10px 0 6px;
    }

    input, select{
      width: 100%;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.95);
      outline: none;
      font-size: 15px;
      color: var(--text);
      transition: box-shadow 120ms ease, border-color 120ms ease, transform 120ms ease;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,0.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,0.14);
    }

    .btn-row{
      display:flex; justify-content:center; gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    button{
      padding: 11px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    button:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(17,24,39,0.08); }
    button:active{ transform: translateY(0px); box-shadow: none; }
    button:disabled{ opacity: 0.6; cursor: not-allowed; transform:none; box-shadow:none; }

    .btnPrimary{
      border: 1px solid rgba(37,99,235,0.35);
      background: linear-gradient(180deg, rgba(37,99,235,1), rgba(37,99,235,0.88));
      color: #fff;
      box-shadow: 0 14px 24px rgba(37,99,235,0.22);
    }
    .btnPrimary:hover{ box-shadow: 0 18px 32px rgba(37,99,235,0.26); }
    .btnGhost{
      background: rgba(255,255,255,0.65);
    }
    .btnDanger{
      border-color: rgba(239,68,68,0.35);
      color: #991B1B;
      background: rgba(239,68,68,0.08);
    }

    .mapWrap{ padding: 16px 18px 18px; }
    .map-stage{
      position: relative;
      width: 100%;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 14px 30px rgba(17,24,39,0.06);
    }
    .map-stage img{
      display: block;
      width: 100%;
      height: auto;
      user-select: none;
      -webkit-user-drag: none;
    }
    .map-stage svg{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    /* 클릭 구역 */
    .region{
      fill: rgba(0,0,0,0);
      cursor: pointer;
      transition: fill 160ms ease, stroke 160ms ease, filter 160ms ease;
      stroke: rgba(37,99,235,0);
      stroke-width: 0;
    }
    .region:hover{
      fill: var(--primary-strong);
      stroke: rgba(37,99,235,0.95);
      stroke-width: 3;
      filter: drop-shadow(0 0 10px rgba(37,99,235,0.30));
    }

    /* 화면3 */
    .contentPad{ padding: 16px 18px 18px; }

    .metaLine{
      display:flex;
      flex-direction: column;
      gap: 6px;
      text-align:left;
    }
    .valueLine{
      font-weight: 800;
      font-size: 22px;
      letter-spacing: -0.3px;
    }
    .subLine{
      font-size: 13px;
      color: var(--muted);
    }
    .questionLine{
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      background: var(--primary-weak);
      border: 1px solid rgba(37,99,235,0.18);
      color: rgba(17,24,39,0.95);
      font-weight: 700;
      font-size: 14px;
      text-align:left;
    }

    .viewer{
      display:grid;
      place-items: center;
      padding-top: 10px;
    }

    .photoFrame{
      position: relative;
      width: 100%;
      max-width: 720px;
    }
    .viewer img#regionImage{
     width: 100%;
     height: auto;
     object-fit: contain;
     border-radius: var(--radius-lg);
     border: 1px solid var(--border);
     background: #fff;
     box-shadow: 0 18px 40px rgba(17,24,39,0.08);
     transform-origin: center center;
     transition: transform 140ms ease;
     display:block;
    }

    /* 캐릭터 */
    .characterHotspot{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(
        calc(-50% + var(--dx, 0%)),
        calc(-50% + var(--dy, 0%))
      ) scale(var(--sc, 1));
      width: clamp(44px, 10vw, 78px);
      height: auto;
      object-fit: contain;
      cursor: pointer;
      pointer-events: auto;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-drag: none;
      background: none;
      border-radius: 0;
      box-shadow: none;
      transition: transform 120ms ease, filter 120ms ease;
      filter: drop-shadow(0 14px 20px rgba(17,24,39,0.22));
    }
    .characterHotspot:hover{
      transform: translate(
        calc(-50% + var(--dx, 0px)),
        calc(-50% + var(--dy, 0px))
      ) scale(calc(var(--sc, 1) * 1.04));
      filter: drop-shadow(0 18px 26px rgba(17,24,39,0.26));
    }

    /* 댓글 */
    .commentsBox{
      margin-top: 16px;
      padding: 14px 14px 12px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.78);
      box-shadow: 0 14px 26px rgba(17,24,39,0.06);
    }
    .commentsHead{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .commentsTitle{
      font-weight: 800;
      letter-spacing: -0.2px;
    }
    .commentsMeta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .commentsList{
      display: grid;
      gap: 10px;
    }
    .commentItem{
      display:flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.92);
    }
    .commentDot{
      margin-top: 6px;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(37,99,235,0.85);
      flex: 0 0 auto;
    }
    .commentText{
      font-size: 14px;
      line-height: 1.4;
      color: var(--text);
      word-break: break-word;
    }
    .commentSub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }
    .commentsHint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }

    /* 툴팁 */
    .tooltip{
      position: fixed;
      z-index: 9999;
      padding: 7px 10px;
      border-radius: 12px;
      background: rgba(17,24,39,0.88);
      color: #fff;
      font-size: 13px;
      pointer-events: none;
      opacity: 0;
      transform: translate(-50%, -120%);
      transition: opacity 80ms ease;
      white-space: nowrap;
      box-shadow: 0 18px 34px rgba(0,0,0,0.24);
    }
    .tooltip.show{ opacity: 1; }

    /* 모달 */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
    }
    .modal.show{ display:flex; }

    .modal-card{
      width: min(420px, 92vw);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(255,255,255,0.55);
      box-shadow: 0 28px 60px rgba(0,0,0,0.25);
      padding: 18px 18px 16px;
      text-align: left;
    }
    .modal-title{
      margin: 0;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -0.2px;
    }
    .modal-hint{
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
    }

    .modal-card input{
      width: 100%;
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.98);
      font-size: 15px;
    }
    .modal-actions{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .note{
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.35;
    }

    @media (max-width: 520px){
      .hTitle{ font-size: 22px; }
      .sectionHead{ padding: 16px; }
      .mapWrap{ padding: 14px; }
      .contentPad{ padding: 14px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- 브랜드바 -->
    <div class="brandbar">
      <div class="brand">
        <div class="brandMark" aria-hidden="true"></div>
        <div class="brandText">
          <div class="t1">비버샘과 가치÷</div>
        </div>
      </div>
    </div>

    <!-- 화면1 -->
    <div id="screen1" class="screen active">
      <div class="section">
        <div class="sectionHead">
          <div>
            <h1 class="hTitle" style="margin:0;">정보를 입력해 주세요.</h1>
            <div class="hDesc">이름과 Cell을 입력해 주세요.</div>
          </div>
          <div class="rightCol">
          </div>
        </div>

        <div class="field">
          <div class="label">이름</div>
          <input type="text" id="name" placeholder="이름을 입력하세요" autocomplete="name" />

          <div class="label">Cell</div>
          <select id="department">
            <option value="">Cell을 선택하세요</option>
            <option value="과학4">과학4</option>
            <option value="교과서정책">교과서정책</option>
            <option value="국어1">국어1</option>
            <option value="국어2">국어2</option>
            <option value="국어3">국어3</option>
            <option value="국어4">국어4</option>
            <option value="국어5">국어5</option>
            <option value="기출탭탭">기출탭탭</option>
            <option value="라키비움">라키비움</option>
            <option value="에듀테크콘텐츠1">에듀테크콘텐츠1</option>
            <option value="에듀테크콘텐츠2">에듀테크콘텐츠2</option>
            <option value="에듀테크콘텐츠3">에듀테크콘텐츠3</option>
            <option value="에듀테크콘텐츠기획">에듀테크콘텐츠기획</option>
            <option value="영어1">영어1</option>
            <option value="영어2">영어2</option>
            <option value="영어4">영어4</option>
            <option value="창의융합콘텐츠">창의융합콘텐츠</option>
            <option value="티칭콘텐츠개발2">티칭콘텐츠개발2</option>
            <option value="티칭콘텐츠개발3">티칭콘텐츠개발3</option>
          </select>

          <div class="btn-row" style="margin-top:18px;">
            <button class="btnPrimary" id="nextBtn">시작하기</button>
          </div>

          <div class="note">※ 입력 정보는 이 기기에 저장되어 다음 접속 시 자동으로 채워집니다.</div>
        </div>
      </div>
    </div>

    <!-- 화면2 -->
    <div id="screen2" class="screen">
      <div class="section">
        <div class="sectionHead">
          <div>
            <h2 class="hTitle" style="margin:0;">각각의 구역을 눌러보세요!</h2>
            <div class="hDesc">
               휴담, 에듀테크존, 도서관, 스마트아카이브, 교과서의 역사 <br>
               스마트클래스, 통실의 구역을 눌러보세요!</div>
            <div class="hDesc oneLine">저장값 초기화를 누르면 기기에 저장된 입력 정보가 초기화 됩니다.</div>
          </div>
          <div class="rightCol">
            <div class="pill" id="userBadge"></div>
            <button id="resetBtn" class="btnDanger">저장값 초기화</button>
          </div>
        </div>

        <div class="mapWrap">
          <div class="map-stage" aria-label="라키비움 지도">
            <img src="floor.png" alt="지도">

            <svg viewBox="0 0 1536 1024" preserveAspectRatio="xMidYMid meet" aria-label="클릭 가능한 7구역">
              <rect class="region" data-region="휴담" x="205" y="115" width="466" height="110" rx="28" ry="28"></rect>
              <rect class="region" data-region="통실" x="671" y="115" width="765" height="287" rx="28" ry="28"></rect>
              <rect class="region" data-region="스마트 클래스" x="1365" y="402" width="70" height="253" rx="28" ry="28"></rect>
              <rect class="region" data-region="도서관" x="97" y="225" width="203" height="447" rx="28" ry="28"></rect>
              <rect class="region" data-region="스마트아카이브" x="97" y="780" width="248" height="88" rx="28" ry="28"></rect>
              <rect class="region" data-region="교과서의 역사" x="345" y="780" width="841" height="88" rx="28" ry="28"></rect>
              <rect class="region" data-region="에듀테크존" x="315" y="225" width="248" height="70" rx="28" ry="28"></rect>
            </svg>
          </div>

          <div class="btn-row">
            <button id="backBtn" class="btnGhost">이전</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 화면3 -->
    <div id="screen3" class="screen">
      <div class="section">
        <div class="sectionHead">
          <div class="metaLine">
            <div class="valueLine" id="regionTitle">구역</div>
            <div class="subLine" id="regionSub"></div>
          </div>
          <div class="rightCol">
            <div class="pill" id="userBadge3"></div>
          </div>
        </div>

        <div class="contentPad">
          <div class="viewer">
            <div class="photoFrame">
              <img id="regionImage" alt="선택된 구역 이미지">
              <img
                id="characterHotspot"
                class="characterHotspot"
                src="character.png"
                alt="한 줄 입력하기"
                title="클릭해서 한 줄 입력"
              />
            </div>
          </div>

          <!-- 최근 경험 5개 -->
          <div class="commentsBox" aria-label="최근 경험">
            <div class="commentsHead">
              <div class="commentsTitle">최근에 남긴 한 줄</div>
              <div class="commentsMeta" id="commentsMeta"></div>
            </div>

            <div id="commentsList" class="commentsList"></div>

            <div class="commentsHint" id="commentsHint">※ 최근 5개를 보여줘요.</div>
          </div>

          <div class="btn-row" style="margin-top:16px;">
            <button id="toMapBtn" class="btnGhost">지도 돌아가기</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 툴팁 -->
    <div id="tooltip" class="tooltip"></div>

    <!-- 답변 모달 -->
    <div id="commentModal" class="modal">
      <div class="modal-card" role="dialog" aria-modal="true" aria-label="답변 입력">
        <h3 class="modal-title">한 줄 남기기</h3>
        <div id="questionText" class="modal-hint"></div>

        <input
          type="text"
          id="commentInput"
          placeholder="여러분의 경험을 적어주세요!"
          maxlength="80"
        />

        <div class="modal-actions">
          <button id="closeCommentBtn" class="btnGhost">취소</button>
          <button id="saveCommentBtn" class="btnPrimary">저장</button>
        </div>

        <div class="note">※ 적어주신 경험은 수집하여 차후 상품 증정에 이용됩니다.</div>
      </div>
    </div>
  </div>

  <script type="module">
    /* Firebase 연동 */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      getDocs,
      query,
      where,
      orderBy,
      limit
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA8n3EetbrAOmJ9BFy7tdSxKjwbobqOcP8",
      authDomain: "visang-find.firebaseapp.com",
      projectId: "visang-find",
      storageBucket: "visang-find.firebasestorage.app",
      messagingSenderId: "543146477593",
      appId: "1:543146477593:web:cf26b2d26ab15893d50288"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function saveCommentToFirestore(region, question, text, name, department) {
      await addDoc(collection(db, "comments"), {
        region,
        question,
        text,
        name,
        department,
        createdAt: serverTimestamp()
      });
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function maskName(rawName){
     if (!rawName) return "";
     const name = String(rawName).trim().replace(/\s+/g, " ");
     if (!name) return "";
     const first = name[0];
     const restLen = Math.max(name.length - 1, 1);
     return first + "*".repeat(restLen);
    }


    async function loadRecentComments(regionName) {
      if (!regionName) return;

      commentsMeta.textContent = "불러오는 중…";
      commentsList.innerHTML = `
        <div class="commentItem"><div class="commentDot"></div><div class="commentText">최근 경험을 불러오고 있어요…</div></div>
      `;

      try {
        const q = query(
          collection(db, "comments"),
          where("region", "==", regionName),
          orderBy("createdAt", "desc"),
          limit(5)
        );

        const snap = await getDocs(q);

        const items = [];
        snap.forEach((doc) => {
          const d = doc.data();
          items.push({
            text: (d.text || "").toString(),
            department: (d.department || "").toString(),
            name: (d.name || "").toString(),
            createdAt: d.createdAt || null
          });
        });

        commentsMeta.textContent = `총 ${items.length}개 표시`;
        commentsHint.textContent = "※ 최근 5개를 보여줘요.";

        if (items.length === 0) {
          commentsList.innerHTML = `
            <div class="commentItem">
              <div class="commentDot"></div>
              <div>
                <div class="commentText">아직 남겨진 경험이 없어요.</div>
                <div class="commentSub">캐릭터를 눌러 첫 번째 한 줄을 남겨보세요!</div>
              </div>
            </div>
          `;
          return;
        }

        /* 나름의 익명성 */
        commentsList.innerHTML = items.map((it) => `
          <div class="commentItem">
            <div class="commentDot"></div>
            <div>
              <div class="commentText">${escapeHtml(it.text)}</div>
              <div class="commentSub">
               ${escapeHtml(it.department || "Cell 미입력")} · ${escapeHtml(maskName(it.name))}
              </div>
            </div>
          </div>
        `).join("");

      } catch (e) {
        console.error(e);
        commentsMeta.textContent = "불러오기 실패";
        commentsHint.textContent = "※ 댓글을 불러오지 못했어요. (콘솔 확인)";
        commentsList.innerHTML = `
          <div class="commentItem">
            <div class="commentDot"></div>
            <div>
              <div class="commentText">최근 경험을 불러오지 못했어요.</div>
              <div class="commentSub">네트워크/권한/인덱스를 확인해주세요.</div>
            </div>
          </div>
        `;
      }
    }

    /* 저장키 */
    const KEY_NAME = "saved_name";
    const KEY_DEPT = "saved_department";
    const KEY_REGION = "saved_region";

    const screen1 = document.getElementById("screen1");
    const screen2 = document.getElementById("screen2");
    const screen3 = document.getElementById("screen3");

    const nameInput = document.getElementById("name");
    const deptSelect = document.getElementById("department");

    const nextBtn = document.getElementById("nextBtn");
    const backBtn = document.getElementById("backBtn");
    const resetBtn = document.getElementById("resetBtn");
    const toMapBtn = document.getElementById("toMapBtn");

    const userBadge = document.getElementById("userBadge");
    const userBadge3 = document.getElementById("userBadge3");

    const regionTitle = document.getElementById("regionTitle");
    const regionSub = document.getElementById("regionSub");
    const regionImage = document.getElementById("regionImage");

    const characterHotspot = document.getElementById("characterHotspot");

    const commentModal = document.getElementById("commentModal");
    const commentInput = document.getElementById("commentInput");
    const saveCommentBtn = document.getElementById("saveCommentBtn");
    const closeCommentBtn = document.getElementById("closeCommentBtn");
    const questionText = document.getElementById("questionText");

    const commentsList = document.getElementById("commentsList");
    const commentsMeta = document.getElementById("commentsMeta");
    const commentsHint = document.getElementById("commentsHint");

    const regionEls = document.querySelectorAll(".region");

    /* 구역 매핑 */
    const regionToImage = {
      "휴담": "hudam.png",
      "통실": "tongsil.png",
      "스마트 클래스": "smart-class.png",
      "도서관": "library.png",
      "스마트아카이브": "archive.png",
      "교과서의 역사": "history.png",
      "에듀테크존": "edutech.png",
    };

    /* 우리의 믿음 7개 */
    const regionToSubTextScreen3 = {
      "휴담": "당연한 것도 낯설게 본다",
      "통실": "현장에서 시작해서 현장을 넘어선다",
      "스마트 클래스": "내가 즐기면서 하는 일이 우리를 성장시킨다",
      "도서관": "나는 성숙한 마음으로 경청하고, 다름을 존중한다",
      "스마트아카이브": "나는 동료가 나의 성장을 위한 동반자임을 믿는다",
      "교과서의 역사": "나는 내가 선택한 이 곳에서 가치 있는 일을 하고 있다",
      "에듀테크존": "오늘의 치열한 고민이 내일 최선의 결과가 된다",
    };

    const regionToQuestion = {
      "휴담": "최근에 “이게 원래 이렇게 하는 거였어?” 하고 다시 보게 된 게 있다면?",
      "통실": "업무나 일을 직접 해보고 나서, 업무나 일에 대한 기존의 생각이 바뀐 경험이 있다면?",
      "스마트 클래스": "요즘 괜히 더 찾아보게 되거나, 자꾸 얘기하고 싶어지는 관심사가 있다면?",
      "도서관": "“아 난 저 생각 못 해봤네” 싶었던 말이나 의견을 들은 적 있다면?",
      "스마트아카이브": "동료가 툭 던진 말인데, 은근히 도움 됐던 적 있다면?",
      "교과서의 역사": "요즘 “아 이래서 이 회사 다니지” 싶었던 순간이 있다면?",
      "에듀테크존": "최근에 고민 많이 해서 “와 이건 잘 샀다 / 잘 했다” 싶은 선택이 있다면?",
    };

    const regionToCharacterImage = {
      "휴담": "character-hudam.png",
      "통실": "character-tongsil.png",
      "스마트 클래스": "character-smartclass.png",
      "도서관": "character-library.png",
      "스마트아카이브": "character-archive.png",
      "교과서의 역사": "character-history.png",
      "에듀테크존": "character-edutech.png",
    };
    const DEFAULT_CHARACTER_IMAGE = "character.png";

    const regionRotation = {
      "휴담": 0, "통실": 0, "스마트 클래스": 0, "도서관": 0,
      "스마트아카이브": 0, "교과서의 역사": 0, "에듀테크존": 0,
    };

    /* 캐릭터 위치 조정 */
    const regionToCharacterPos = {
      "휴담": { x: 50, y: 71 },
      "통실": { x: 50, y: 50 },
      "스마트 클래스": { x: 15, y: 80 },
      "도서관": { x: 77, y: 57 },
      "스마트아카이브": { x: 27, y: 52 },
      "교과서의 역사": { x: 50, y: 33 },
      "에듀테크존": { x: 34, y: 71 },
    };

    /* 캐릭터 위치 조정-미세오프셋 */
    const regionToCharacterOffset = {
      "휴담": { dx: 1.5, dy: 0.8 },
      "통실": { dx: 0, dy: 0 },
      "스마트 클래스": { dx: 0, dy: 0 },
      "도서관": { dx: 0.8, dy: 1.0 },
      "스마트아카이브": { dx: 0.4, dy: 0.9 },
      "교과서의 역사": { dx: 0.4, dy: 0.7 },
      "에듀테크존": { dx: 1.0, dy: 0.9 },
    };

    /* 구역별 캐릭터 크기-배율로.. */
    const regionToCharacterScale = {
      "휴담": 1.2,
      "통실": 1.0,
      "스마트 클래스": 1.75,
      "도서관": 1.3,
      "스마트아카이브": 1.15,
      "교과서의 역사": 1.0,
      "에듀테크존": 1.0,
    };

    /* 라우팅 */
    function renderScreen(n) {
      screen1.classList.toggle("active", n === 1);
      screen2.classList.toggle("active", n === 2);
      screen3.classList.toggle("active", n === 3);
    }

    function go(screenNum, replace = false) {
      const state = { screen: screenNum };
      const url = `#s${screenNum}`;
      if (replace) history.replaceState(state, "", url);
      else history.pushState(state, "", url);
      renderScreen(screenNum);
    }

    function screenFromHash() {
      const h = (location.hash || "").toLowerCase();
      if (h === "#s2") return 2;
      if (h === "#s3") return 3;
      return 1;
    }

    window.addEventListener("popstate", () => {
      renderScreen(screenFromHash());
    });

    /* 저장과 로딩 */
    function saveInputs(name, dept) {
      localStorage.setItem(KEY_NAME, name);
      localStorage.setItem(KEY_DEPT, dept);
    }

    function loadInputs() {
      const savedName = localStorage.getItem(KEY_NAME) || "";
      const savedDept = localStorage.getItem(KEY_DEPT) || "";
      if (savedName) nameInput.value = savedName;
      if (savedDept) deptSelect.value = savedDept;
    }

    function updateBadges() {
      const n = (localStorage.getItem(KEY_NAME) || "").trim();
      const d = localStorage.getItem(KEY_DEPT) || "";
      const text = (n && d) ? `${n} · ${d}` : "";
      userBadge.textContent = text;
      userBadge3.textContent = text;
    }

    function nextScreen() {
      const name = nameInput.value.trim();
      const dept = deptSelect.value;

      if (!name || !dept) {
        alert("이름과 부서를 모두 입력/선택해주세요!");
        return;
      }

      saveInputs(name, dept);
      updateBadges();
      go(2);
    }

    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") nextScreen();
    });
    deptSelect.addEventListener("keydown", (e) => {
      if (e.key === "Enter") nextScreen();
    });

    function openRegion(regionName) {
      regionName = (regionName || "").trim();
      localStorage.setItem(KEY_REGION, regionName);

      const imgSrc = regionToImage[regionName];

      regionTitle.textContent = regionName;
      regionSub.textContent = regionToSubTextScreen3[regionName] || "";

      const q = regionToQuestion[regionName] || "이 공간에 대한 한 줄을 남겨주세요.";

      if (imgSrc) {
        regionImage.src = imgSrc;
        regionImage.alt = `${regionName} 이미지`;
        const deg = regionRotation[regionName] ?? 0;
        regionImage.style.transform = `rotate(${deg}deg)`;
      } else {
        regionImage.removeAttribute("src");
        regionImage.alt = "이미지가 없습니다.";
        regionImage.style.transform = "rotate(0deg)";
      }

      const charSrc = regionToCharacterImage[regionName] || DEFAULT_CHARACTER_IMAGE;
      characterHotspot.src = charSrc;

      /* 캐릭터 위치 */
      const pos = regionToCharacterPos[regionName] || { x: 50, y: 50 };
      characterHotspot.style.left = `${pos.x}%`;
      characterHotspot.style.top = `${pos.y}%`;

      /* 미세오프셋 적용 */
      const off = regionToCharacterOffset[regionName] || { dx: 0, dy: 0 };
      characterHotspot.style.setProperty("--dx", `${off.dx}%`);
      characterHotspot.style.setProperty("--dy", `${off.dy}%`);

      /* 캐릭터 배율 적용 */
      const sc = regionToCharacterScale[regionName] || 1;
      characterHotspot.style.setProperty("--sc", sc);

      updateBadges();
      go(3);

      /* 최근 5개 로딩 */
      loadRecentComments(regionName);
    }

    function resetAll() {
      localStorage.removeItem(KEY_NAME);
      localStorage.removeItem(KEY_DEPT);
      localStorage.removeItem(KEY_REGION);
      nameInput.value = "";
      deptSelect.value = "";
      alert("저장된 값이 초기화됐어요!");
      go(1, true);
    }

    nextBtn.addEventListener("click", nextScreen);
    backBtn.addEventListener("click", () => go(1));
    toMapBtn.addEventListener("click", () => go(2));
    resetBtn.addEventListener("click", resetAll);

    regionEls.forEach(el => {
      el.addEventListener("click", () => openRegion(el.dataset.region));
    });

    /* 툴팁 */
    const tooltip = document.getElementById("tooltip");
    function showTooltip(text, clientX, clientY) {
      tooltip.textContent = text;
      tooltip.style.left = `${clientX}px`;
      tooltip.style.top = `${clientY}px`;
      tooltip.classList.add("show");
    }
    function moveTooltip(clientX, clientY) {
      tooltip.style.left = `${clientX}px`;
      tooltip.style.top = `${clientY}px`;
    }
    function hideTooltip() {
      tooltip.classList.remove("show");
    }

    regionEls.forEach(el => {
      const name = el.dataset.region;

      el.addEventListener("mouseenter", (e) => showTooltip(name, e.clientX, e.clientY));
      el.addEventListener("mousemove", (e) => moveTooltip(e.clientX, e.clientY));
      el.addEventListener("mouseleave", hideTooltip);

      el.addEventListener("touchstart", (e) => {
        const t = e.touches[0];
        showTooltip(name, t.clientX, t.clientY);
        setTimeout(hideTooltip, 900);
      }, { passive: true });
    });

    window.addEventListener("scroll", hideTooltip, { passive: true });
    window.addEventListener("resize", hideTooltip);

    /* 퍼펙트 클릭(투명영역 무시) */
    function makePixelPerfectClickable(imgEl, onHit) {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      function drawToCanvas() {
        const w = imgEl.naturalWidth;
        const h = imgEl.naturalHeight;
        if (!w || !h) return false;
        canvas.width = w;
        canvas.height = h;
        ctx.clearRect(0, 0, w, h);
        ctx.drawImage(imgEl, 0, 0);
        return true;
      }

      if (imgEl.complete) drawToCanvas();
      imgEl.addEventListener("load", drawToCanvas);

      ["pointerdown", "pointerup"].forEach((evt) => {
       imgEl.addEventListener(evt, (e) => {
         const rect = imgEl.getBoundingClientRect();
         const x = Math.floor((e.clientX - rect.left) * (imgEl.naturalWidth / rect.width));
         const y = Math.floor((e.clientY - rect.top) * (imgEl.naturalHeight / rect.height));
         if (x < 0 || y < 0 || x >= imgEl.naturalWidth || y >= imgEl.naturalHeight) return;
         if (!imgEl.naturalWidth || !imgEl.naturalHeight) return;
         let alpha = 255;
         try{
           const pixel = ctx.getImageData(x, y, 1, 1).data;
           alpha = pixel[3];
          }catch(err){
           onHit(e);
           return;
          }
           if (alpha > 5) onHit(e);
        });
      });
    }

    /* 모달->입력 */
    function openCommentModal(){
      const region = localStorage.getItem(KEY_REGION);
      if (!region) return;

      const q = regionToQuestion[region] || "이 공간에 대한 한 줄을 남겨주세요.";
      questionText.textContent = q;

      commentInput.value = "";
      commentModal.classList.add("show");
      commentInput.focus();
    }

    makePixelPerfectClickable(characterHotspot, () => {
      openCommentModal();
    });

    closeCommentBtn.addEventListener("click", () => {
      commentModal.classList.remove("show");
    });

    commentModal.addEventListener("click", (e) => {
      if (e.target === commentModal) commentModal.classList.remove("show");
    });

    saveCommentBtn.addEventListener("click", async () => {
      const region = localStorage.getItem(KEY_REGION);
      const text = commentInput.value.trim();

      if (!text) {
        alert("답변을 입력해주세요!");
        return;
      }

      const name = (localStorage.getItem(KEY_NAME) || "익명").trim();
      const department = localStorage.getItem(KEY_DEPT) || "";
      const question = regionToQuestion[region] || "이 공간에 대한 한 줄을 남겨주세요.";

      saveCommentBtn.disabled = true;
      saveCommentBtn.textContent = "저장 중...";

      try {
        await saveCommentToFirestore(region, question, text, name, department);

        commentModal.classList.remove("show");
        commentInput.value = "";

        /* 저장 성공! */
        await loadRecentComments(region);

        alert("저장됐어요!");
      } catch (e) {
        console.error(e);
        alert("저장 중 오류가 발생했어요. (콘솔 확인)");
      } finally {
        saveCommentBtn.disabled = false;
        saveCommentBtn.textContent = "저장";
      }
    });

    commentInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        saveCommentBtn.click();
      }
    });

    /* 초기 로딩 */
    loadInputs();
    updateBadges();

    (function initRoute() {
      const hasUser =
        (localStorage.getItem(KEY_NAME) || "").trim() &&
        (localStorage.getItem(KEY_DEPT) || "");

      const target = screenFromHash();

      if (!hasUser && target !== 1) {
        go(1, true);
        return;
      }

      if (target === 3) {
        const savedRegion = localStorage.getItem(KEY_REGION);
        if (!savedRegion) {
          go(2, true);
          return;
        }
        openRegion(savedRegion);
        history.replaceState({ screen: 3 }, "", "#s3");
        return;
      }

      go(target, true);
    })();
  </script>
</body>
</html>
